<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Miaoda - æµ‹è¯•æ¨¡å¼</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    
    /* æµ‹è¯•æ¨¡å¼æ ‡è®° */
    .test-mode-banner {
      position: fixed;
      top: 0;
      right: 0;
      background: #ff6b00;
      color: white;
      padding: 5px 20px;
      font-size: 12px;
      z-index: 9999;
      transform: rotate(45deg);
      transform-origin: right top;
      margin-top: 30px;
      margin-right: -50px;
      width: 200px;
      text-align: center;
    }
    
    /* è°ƒè¯•é¢æ¿ */
    .debug-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 200px;
      background: #252525;
      border-top: 2px solid #ff6b00;
      padding: 10px;
      display: none;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      z-index: 9998;
    }
    
    .debug-panel.active {
      display: block;
    }
    
    .debug-toggle {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #ff6b00;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 9999;
      font-size: 12px;
    }
    
    /* æµ‹è¯•æ§åˆ¶é¢æ¿ */
    .test-controls {
      position: fixed;
      top: 60px;
      right: 10px;
      background: #2d2d2d;
      border: 1px solid #ff6b00;
      border-radius: 8px;
      padding: 15px;
      width: 250px;
      z-index: 9997;
    }
    
    .test-controls h4 {
      color: #ff6b00;
      margin-bottom: 10px;
    }
    
    .test-control-item {
      margin: 10px 0;
    }
    
    .test-control-item label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }
    
    .test-control-item input[type="checkbox"] {
      cursor: pointer;
    }
    
    .test-button {
      background: #ff6b00;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
    }
    
    .test-button:hover {
      background: #e55a00;
    }
    
    /* ä¸»å¸ƒå±€ */
    .sidebar {
      width: 200px;
      background: #252525;
      border-right: 1px solid #3e3e3e;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #3e3e3e;
    }
    
    .logo {
      font-size: 1.5em;
      font-weight: bold;
      color: #0dbc79;
    }
    
    .nav-menu {
      flex: 1;
      padding: 10px 0;
    }
    
    .nav-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-item:hover {
      background: #2d2d2d;
    }
    
    .nav-item.active {
      background: #2d2d2d;
      border-left: 3px solid #0dbc79;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: #2d2d2d;
      padding: 20px;
      border-bottom: 1px solid #3e3e3e;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .content {
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    
    .panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: none;
      overflow-y: auto;
      padding: 30px;
    }
    
    .panel.active {
      display: block;
    }
    
    .status-bar {
      background: #252525;
      border-top: 1px solid #3e3e3e;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
    }
    
    /* æµ‹è¯•æ ·å¼ */
    .test-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
      animation: blink 1s infinite;
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    .success { background: #0dbc79; }
    .error { background: #cd3131; }
    .warning { background: #ff6b00; }
    
    button {
      background: #0dbc79;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    
    button:hover {
      background: #0ba568;
    }
    
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- æµ‹è¯•æ¨¡å¼æ ‡è®° -->
  <div class="test-mode-banner">æµ‹è¯•æ¨¡å¼</div>
  
  <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
  <div class="test-controls">
    <h4>ğŸ§ª æµ‹è¯•æ§åˆ¶</h4>
    
    <div class="test-control-item">
      <label>
        <input type="checkbox" id="test-auto-refresh" checked>
        è‡ªåŠ¨åˆ·æ–°ç¯å¢ƒ (5ç§’)
      </label>
    </div>
    
    <div class="test-control-item">
      <label>
        <input type="checkbox" id="test-mock-claude" checked>
        æ¨¡æ‹Ÿ Claude å“åº”
      </label>
    </div>
    
    <div class="test-control-item">
      <label>
        <input type="checkbox" id="test-show-logs" checked>
        æ˜¾ç¤ºè°ƒè¯•æ—¥å¿—
      </label>
    </div>
    
    <div style="margin-top: 15px;">
      <h5>å¿«é€Ÿæµ‹è¯•</h5>
      <button class="test-button" onclick="testEnvCheck()">æµ‹è¯•ç¯å¢ƒæ£€æµ‹</button>
      <button class="test-button" onclick="testConfigSave()">æµ‹è¯•é…ç½®ä¿å­˜</button>
      <button class="test-button" onclick="testClaudeStart()">æµ‹è¯•å¯åŠ¨Claude</button>
      <button class="test-button" onclick="simulateError()">æ¨¡æ‹Ÿé”™è¯¯</button>
      <button class="test-button" onclick="fillTestData()">å¡«å……æµ‹è¯•æ•°æ®</button>
    </div>
  </div>
  
  <!-- ä¾§è¾¹æ  -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo">Miaoda <span style="font-size: 0.6em; color: #ff6b00;">[TEST]</span></div>
    </div>
    <nav class="nav-menu">
      <div class="nav-item active" onclick="showPanel('environment')">
        <span>ğŸŒ</span>
        <span>ç¯å¢ƒæ£€æµ‹</span>
      </div>
      <div class="nav-item" onclick="showPanel('config')">
        <span>âš™ï¸</span>
        <span>é…ç½®ç®¡ç†</span>
      </div>
      <div class="nav-item" onclick="showPanel('terminal')">
        <span>ğŸ’»</span>
        <span>ç»ˆç«¯</span>
      </div>
      <div class="nav-item" onclick="showPanel('test')">
        <span>ğŸ§ª</span>
        <span>æµ‹è¯•é¢æ¿</span>
      </div>
    </nav>
  </div>
  
  <!-- ä¸»å†…å®¹ -->
  <div class="main-content">
    <div class="header">
      <h2 id="panel-title">ç¯å¢ƒæ£€æµ‹</h2>
      <div id="header-actions">
        <button onclick="refreshEnvironment()">åˆ·æ–°</button>
      </div>
    </div>
    
    <div class="content">
      <!-- ç¯å¢ƒæ£€æµ‹é¢æ¿ -->
      <div id="environment-panel" class="panel active">
        <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; max-width: 800px; margin: 0 auto;">
          <h3>ç³»ç»Ÿä¾èµ– <span class="test-indicator warning"></span></h3>
          <div id="env-list" style="margin-top: 20px;">
            <div style="padding: 15px 0; border-bottom: 1px solid #3e3e3e;">
              <span>Node.js</span>
              <span id="nodejs-status" style="float: right;">æ£€æµ‹ä¸­...</span>
            </div>
            <div style="padding: 15px 0; border-bottom: 1px solid #3e3e3e;">
              <span>Git</span>
              <span id="git-status" style="float: right;">æ£€æµ‹ä¸­...</span>
            </div>
            <div style="padding: 15px 0; border-bottom: 1px solid #3e3e3e;">
              <span>Claude CLI</span>
              <span id="claude-status" style="float: right;">æ£€æµ‹ä¸­...</span>
            </div>
            <div style="padding: 15px 0;">
              <span>UV (Python)</span>
              <span id="uv-status" style="float: right;">æ£€æµ‹ä¸­...</span>
            </div>
          </div>
          
          <div style="margin-top: 20px; padding: 15px; background: #1e1e1e; border-radius: 4px;">
            <h4>æµ‹è¯•ä¿¡æ¯</h4>
            <p>æ£€æµ‹æ¬¡æ•°: <span id="check-count">0</span></p>
            <p>æœ€åæ£€æµ‹: <span id="last-check">-</span></p>
            <p>å“åº”æ—¶é—´: <span id="response-time">-</span></p>
          </div>
        </div>
      </div>
      
      <!-- é…ç½®ç®¡ç†é¢æ¿ -->
      <div id="config-panel" class="panel">
        <div style="display: flex; gap: 20px; max-width: 1200px; margin: 0 auto;">
          <div style="width: 300px; background: #2d2d2d; padding: 20px; border-radius: 8px;">
            <h3>é…ç½®åˆ—è¡¨</h3>
            <button onclick="createNewConfig()" style="margin: 10px 0;">æ–°å»ºé…ç½®</button>
            <div id="config-list-items"></div>
          </div>
          
          <div style="flex: 1; background: #2d2d2d; padding: 20px; border-radius: 8px;">
            <h3>ç¼–è¾‘é…ç½®</h3>
            <form id="config-form">
              <input type="hidden" id="config-id">
              <div style="margin: 15px 0;">
                <label>é…ç½®åç§°</label>
                <input type="text" id="config-name" style="width: 100%; padding: 8px; margin-top: 5px;">
              </div>
              <div style="margin: 15px 0;">
                <label>API Key</label>
                <input type="password" id="config-apikey" style="width: 100%; padding: 8px; margin-top: 5px;">
              </div>
              <div style="margin: 15px 0;">
                <label>æ¨¡å‹</label>
                <select id="config-model" style="width: 100%; padding: 8px; margin-top: 5px;">
                  <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                  <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                  <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                </select>
              </div>
              <button type="button" onclick="saveConfig()">ä¿å­˜</button>
              <button type="button" onclick="testConfig()" style="background: #ff6b00;">æµ‹è¯•è¿æ¥</button>
              <button type="button" onclick="deleteConfig()" style="background: #cd3131;">åˆ é™¤</button>
            </form>
          </div>
        </div>
      </div>
      
      <!-- ç»ˆç«¯é¢æ¿ -->
      <div id="terminal-panel" class="panel">
        <div style="max-width: 1000px; margin: 0 auto;">
          <div style="background: #2d2d2d; padding: 20px; border-radius: 8px 8px 0 0;">
            <span>Claude ç»ˆç«¯</span>
            <button id="claude-toggle" onclick="toggleClaude()" style="float: right;">å¯åŠ¨ Claude</button>
            <span id="claude-status-text" style="float: right; margin-right: 20px; color: #666;">æœªå¯åŠ¨</span>
          </div>
          <div id="terminal-output" style="background: #000; padding: 20px; height: 400px; overflow-y: auto; font-family: monospace;">
            <div style="color: #0dbc79;">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</div>
            <div style="color: #0dbc79;">â•‘           Miaoda Claude Terminal [TEST MODE]                   â•‘</div>
            <div style="color: #0dbc79;">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</div>
            <div style="margin-top: 10px; color: #ff6b00;">ğŸ§ª æµ‹è¯•æ¨¡å¼å·²å¯ç”¨ - æ‰€æœ‰å“åº”éƒ½æ˜¯æ¨¡æ‹Ÿçš„</div>
          </div>
          <div style="background: #2d2d2d; padding: 10px; border-radius: 0 0 8px 8px;">
            <input type="text" id="terminal-input" placeholder="è¾“å…¥æµ‹è¯•å‘½ä»¤..." style="width: 100%; padding: 8px; background: #1e1e1e; border: 1px solid #3e3e3e; color: #d4d4d4;" disabled>
          </div>
        </div>
      </div>
      
      <!-- æµ‹è¯•é¢æ¿ -->
      <div id="test-panel" class="panel">
        <div style="max-width: 1000px; margin: 0 auto;">
          <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3>ğŸ§ª æµ‹è¯•ä»ªè¡¨æ¿</h3>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
              <div style="background: #1e1e1e; padding: 15px; border-radius: 4px;">
                <h4>ç¯å¢ƒæµ‹è¯•</h4>
                <p>çŠ¶æ€: <span class="test-indicator success"></span> æ­£å¸¸</p>
                <p>æ£€æµ‹æ¬¡æ•°: <span id="test-env-count">0</span></p>
                <button class="test-button" onclick="runEnvTest()">è¿è¡Œæµ‹è¯•</button>
              </div>
              
              <div style="background: #1e1e1e; padding: 15px; border-radius: 4px;">
                <h4>é…ç½®æµ‹è¯•</h4>
                <p>çŠ¶æ€: <span class="test-indicator warning"></span> å¾…æµ‹</p>
                <p>é…ç½®æ•°é‡: <span id="test-config-count">0</span></p>
                <button class="test-button" onclick="runConfigTest()">è¿è¡Œæµ‹è¯•</button>
              </div>
              
              <div style="background: #1e1e1e; padding: 15px; border-radius: 4px;">
                <h4>Claude æµ‹è¯•</h4>
                <p>çŠ¶æ€: <span class="test-indicator error"></span> æœªå¯åŠ¨</p>
                <p>æ¶ˆæ¯æ•°: <span id="test-msg-count">0</span></p>
                <button class="test-button" onclick="runClaudeTest()">è¿è¡Œæµ‹è¯•</button>
              </div>
            </div>
          </div>
          
          <div style="background: #2d2d2d; padding: 20px; border-radius: 8px;">
            <h3>æµ‹è¯•æ—¥å¿—</h3>
            <div id="test-logs" style="background: #1e1e1e; padding: 15px; border-radius: 4px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
              <div>[INFO] æµ‹è¯•æ¨¡å¼å·²å¯åŠ¨</div>
              <div>[INFO] ç­‰å¾…æµ‹è¯•å‘½ä»¤...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
      <span>ç‰ˆæœ¬: <span id="app-version">2.1.0</span> [æµ‹è¯•æ¨¡å¼]</span>
      <span id="status-text">å°±ç»ª</span>
      <span>å†…å­˜: <span id="memory-usage">-</span> MB</span>
    </div>
  </div>
  
  <!-- è°ƒè¯•é¢æ¿ -->
  <div class="debug-panel" id="debug-panel">
    <div style="color: #ff6b00; font-weight: bold;">è°ƒè¯•æ§åˆ¶å°</div>
    <div id="debug-logs"></div>
  </div>
  
  <!-- è°ƒè¯•å¼€å…³ -->
  <button class="debug-toggle" onclick="toggleDebug()">è°ƒè¯•æ§åˆ¶å°</button>
  
  <script>
    // æµ‹è¯•æ¨¡å¼å…¨å±€çŠ¶æ€
    const TEST_MODE = true;
    let debugMode = false;
    let autoRefreshInterval = null;
    let checkCount = 0;
    let messageCount = 0;
    let testConfigs = [];
    let currentConfig = null;
    let claudeRunning = false;
    
    // æµ‹è¯•æ—¥å¿—
    function log(message, type = 'INFO') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] [${type}] ${message}`;
      
      // å†™å…¥æµ‹è¯•æ—¥å¿—é¢æ¿
      const testLogs = document.getElementById('test-logs');
      if (testLogs) {
        const div = document.createElement('div');
        div.textContent = logEntry;
        div.style.color = type === 'ERROR' ? '#cd3131' : type === 'WARNING' ? '#ff6b00' : '#d4d4d4';
        testLogs.appendChild(div);
        testLogs.scrollTop = testLogs.scrollHeight;
      }
      
      // å†™å…¥è°ƒè¯•æ§åˆ¶å°
      if (debugMode) {
        const debugLogs = document.getElementById('debug-logs');
        const div = document.createElement('div');
        div.textContent = logEntry;
        debugLogs.appendChild(div);
        debugLogs.scrollTop = debugLogs.scrollHeight;
      }
      
      console.log(logEntry);
    }
    
    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      log('åº”ç”¨å¯åŠ¨ - æµ‹è¯•æ¨¡å¼');
      initializeTestMode();
    });
    
    function initializeTestMode() {
      // åˆå§‹åŒ–ç‰ˆæœ¬
      window.electronAPI.getVersion().then(version => {
        document.getElementById('app-version').textContent = version;
      }).catch(() => {
        document.getElementById('app-version').textContent = '2.1.0';
      });
      
      // è®¾ç½®äº‹ä»¶ç›‘å¬
      setupEventListeners();
      
      // åŠ è½½æµ‹è¯•æ•°æ®
      loadTestData();
      
      // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
      if (document.getElementById('test-auto-refresh').checked) {
        startAutoRefresh();
      }
      
      // æ›´æ–°å†…å­˜ä½¿ç”¨
      setInterval(updateMemoryUsage, 2000);
      
      log('æµ‹è¯•æ¨¡å¼åˆå§‹åŒ–å®Œæˆ');
    }
    
    function setupEventListeners() {
      // ç»ˆç«¯è¾“å…¥
      const terminalInput = document.getElementById('terminal-input');
      terminalInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && claudeRunning) {
          const command = e.target.value.trim();
          if (command) {
            sendTestCommand(command);
            e.target.value = '';
          }
        }
      });
      
      // Claude è¾“å‡ºç›‘å¬
      if (window.electronAPI.onClaudeOutput) {
        window.electronAPI.onClaudeOutput((data) => {
          addToTerminal(data.text, data.type);
        });
      }
      
      // æµ‹è¯•æ§åˆ¶
      document.getElementById('test-auto-refresh').addEventListener('change', (e) => {
        if (e.target.checked) {
          startAutoRefresh();
        } else {
          stopAutoRefresh();
        }
      });
    }
    
    // é¢æ¿åˆ‡æ¢
    function showPanel(panelName) {
      log(`åˆ‡æ¢åˆ°é¢æ¿: ${panelName}`);
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      
      document.querySelectorAll('.panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.getElementById(`${panelName}-panel`).classList.add('active');
      
      const titles = {
        environment: 'ç¯å¢ƒæ£€æµ‹',
        config: 'é…ç½®ç®¡ç†',
        terminal: 'ç»ˆç«¯',
        test: 'æµ‹è¯•é¢æ¿'
      };
      document.getElementById('panel-title').textContent = titles[panelName];
      
      const headerActions = document.getElementById('header-actions');
      if (panelName === 'environment') {
        headerActions.innerHTML = '<button onclick="refreshEnvironment()">åˆ·æ–°</button>';
      } else {
        headerActions.innerHTML = '';
      }
    }
    
    // ç¯å¢ƒæ£€æµ‹
    async function refreshEnvironment() {
      const startTime = Date.now();
      checkCount++;
      
      log('å¼€å§‹ç¯å¢ƒæ£€æµ‹...');
      document.getElementById('check-count').textContent = checkCount;
      
      // æ¨¡æ‹Ÿç¯å¢ƒæ£€æµ‹
      const mockData = {
        nodejs: { installed: true, version: 'v20.10.0' },
        git: { installed: true, version: '2.39.5' },
        claude: { installed: Math.random() > 0.2, version: '1.0.60' },
        uv: { installed: Math.random() > 0.5, version: '0.1.0' }
      };
      
      // å¦‚æœè¿æ¥äº†çœŸå®åç«¯
      try {
        if (window.electronAPI.checkEnvironment) {
          const realData = await window.electronAPI.checkEnvironment();
          Object.assign(mockData, realData);
        }
      } catch (error) {
        log('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®: ' + error.message, 'WARNING');
      }
      
      // æ›´æ–°æ˜¾ç¤º
      Object.entries(mockData).forEach(([key, data]) => {
        const statusEl = document.getElementById(`${key}-status`);
        if (statusEl) {
          if (data.installed) {
            statusEl.innerHTML = `<span style="color: #0dbc79;">âœ… ${data.version}</span>`;
          } else {
            statusEl.innerHTML = '<span style="color: #cd3131;">âŒ æœªå®‰è£…</span>';
          }
        }
      });
      
      const responseTime = Date.now() - startTime;
      document.getElementById('last-check').textContent = new Date().toLocaleTimeString();
      document.getElementById('response-time').textContent = `${responseTime}ms`;
      
      log(`ç¯å¢ƒæ£€æµ‹å®Œæˆï¼Œè€—æ—¶: ${responseTime}ms`);
    }
    
    // é…ç½®ç®¡ç†
    function loadTestData() {
      testConfigs = [
        { id: '1', name: 'æµ‹è¯•é…ç½®1', apiKey: 'sk-test-123...', model: 'claude-3-opus-20240229' },
        { id: '2', name: 'æµ‹è¯•é…ç½®2', apiKey: 'sk-test-456...', model: 'claude-3-sonnet-20240229' },
        { id: '3', name: 'ç”Ÿäº§é…ç½®[å‹¿åˆ ]', apiKey: 'sk-prod-789...', model: 'claude-3-opus-20240229' }
      ];
      
      renderConfigList();
      if (testConfigs.length > 0) {
        selectConfig(testConfigs[0]);
      }
      
      document.getElementById('test-config-count').textContent = testConfigs.length;
    }
    
    function renderConfigList() {
      const listEl = document.getElementById('config-list-items');
      listEl.innerHTML = testConfigs.map(config => `
        <div onclick="selectConfig('${config.id}')" style="padding: 10px; cursor: pointer; margin: 5px 0; background: ${currentConfig?.id === config.id ? '#3e3e3e' : '#1e1e1e'}; border-radius: 4px;">
          <div>${config.name}</div>
          <div style="font-size: 0.8em; color: #666;">${config.model}</div>
        </div>
      `).join('');
    }
    
    function selectConfig(configOrId) {
      const config = typeof configOrId === 'string' 
        ? testConfigs.find(c => c.id === configOrId)
        : configOrId;
        
      if (!config) return;
      
      currentConfig = config;
      document.getElementById('config-id').value = config.id;
      document.getElementById('config-name').value = config.name;
      document.getElementById('config-apikey').value = config.apiKey || '';
      document.getElementById('config-model').value = config.model;
      renderConfigList();
      
      log(`é€‰æ‹©é…ç½®: ${config.name}`);
    }
    
    function createNewConfig() {
      const newConfig = {
        id: Date.now().toString(),
        name: `æµ‹è¯•é…ç½®${testConfigs.length + 1}`,
        apiKey: 'sk-test-' + Math.random().toString(36).substr(2, 9),
        model: 'claude-3-opus-20240229'
      };
      testConfigs.push(newConfig);
      selectConfig(newConfig);
      document.getElementById('test-config-count').textContent = testConfigs.length;
      
      log(`åˆ›å»ºæ–°é…ç½®: ${newConfig.name}`);
    }
    
    async function saveConfig() {
      if (!currentConfig) return;
      
      currentConfig.name = document.getElementById('config-name').value;
      currentConfig.apiKey = document.getElementById('config-apikey').value;
      currentConfig.model = document.getElementById('config-model').value;
      
      renderConfigList();
      log(`ä¿å­˜é…ç½®: ${currentConfig.name}`, 'INFO');
      alert('é…ç½®å·²ä¿å­˜ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰');
    }
    
    function testConfig() {
      log('æµ‹è¯•é…ç½®è¿æ¥...', 'INFO');
      setTimeout(() => {
        const success = Math.random() > 0.3;
        if (success) {
          log('é…ç½®æµ‹è¯•æˆåŠŸï¼', 'INFO');
          alert('è¿æ¥æµ‹è¯•æˆåŠŸï¼ï¼ˆæ¨¡æ‹Ÿï¼‰');
        } else {
          log('é…ç½®æµ‹è¯•å¤±è´¥', 'ERROR');
          alert('è¿æ¥æµ‹è¯•å¤±è´¥ï¼ï¼ˆæ¨¡æ‹Ÿï¼‰');
        }
      }, 1000);
    }
    
    // ç»ˆç«¯åŠŸèƒ½
    async function toggleClaude() {
      if (claudeRunning) {
        stopClaude();
      } else {
        startClaude();
      }
    }
    
    function startClaude() {
      if (!currentConfig) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé…ç½®ï¼');
        showPanel('config');
        return;
      }
      
      claudeRunning = true;
      document.getElementById('claude-toggle').textContent = 'åœæ­¢ Claude';
      document.getElementById('claude-status-text').textContent = 'è¿è¡Œä¸­';
      document.getElementById('claude-status-text').style.color = '#0dbc79';
      document.getElementById('terminal-input').disabled = false;
      document.getElementById('status-text').textContent = 'Claude è¿è¡Œä¸­';
      
      addToTerminal('[ç³»ç»Ÿ] æ­£åœ¨å¯åŠ¨ Claudeï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰...', 'system');
      
      setTimeout(() => {
        addToTerminal('[ç³»ç»Ÿ] Claude å·²å¯åŠ¨', 'system');
        addToTerminal('Claude: ä½ å¥½ï¼æˆ‘æ˜¯æµ‹è¯•æ¨¡å¼çš„ Claudeï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ', 'claude');
      }, 1000);
      
      log('Claude å·²å¯åŠ¨ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰');
    }
    
    function stopClaude() {
      claudeRunning = false;
      document.getElementById('claude-toggle').textContent = 'å¯åŠ¨ Claude';
      document.getElementById('claude-status-text').textContent = 'æœªå¯åŠ¨';
      document.getElementById('claude-status-text').style.color = '#666';
      document.getElementById('terminal-input').disabled = true;
      document.getElementById('status-text').textContent = 'å°±ç»ª';
      
      addToTerminal('[ç³»ç»Ÿ] Claude å·²åœæ­¢', 'system');
      log('Claude å·²åœæ­¢');
    }
    
    function sendTestCommand(command) {
      messageCount++;
      document.getElementById('test-msg-count').textContent = messageCount;
      
      addToTerminal('> ' + command, 'user');
      log(`å‘é€å‘½ä»¤: ${command}`);
      
      // æ¨¡æ‹Ÿå“åº”
      if (document.getElementById('test-mock-claude').checked) {
        setTimeout(() => {
          const responses = [
            'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å“åº”ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºçœŸå®çš„ Claude å›å¤ã€‚',
            'æˆ‘ç†è§£ä½ çš„é—®é¢˜ã€‚è®©æˆ‘ç”¨æµ‹è¯•æ•°æ®æ¥æ¼”ç¤º...',
            'æµ‹è¯•æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰å“åº”éƒ½æ˜¯é¢„è®¾çš„ã€‚å®é™…ä½¿ç”¨æ—¶ä¼šè¿æ¥çœŸå®çš„ Claude APIã€‚',
            `ä½ åˆšæ‰è¯´çš„æ˜¯ï¼š"${command}"ã€‚è¿™æ˜¯ç¬¬ ${messageCount} æ¡æ¶ˆæ¯ã€‚`
          ];
          const response = responses[Math.floor(Math.random() * responses.length)];
          addToTerminal('Claude: ' + response, 'claude');
        }, 1000 + Math.random() * 1000);
      }
    }
    
    function addToTerminal(text, type = 'normal') {
      const output = document.getElementById('terminal-output');
      const line = document.createElement('div');
      line.style.marginBottom = '5px';
      
      switch(type) {
        case 'system':
          line.style.color = '#e5e510';
          break;
        case 'claude':
          line.style.color = '#0dbc79';
          break;
        case 'user':
          line.style.color = '#d4d4d4';
          break;
        case 'error':
          line.style.color = '#cd3131';
          break;
      }
      
      line.textContent = text;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }
    
    // æµ‹è¯•åŠŸèƒ½
    function startAutoRefresh() {
      log('å¯åŠ¨è‡ªåŠ¨åˆ·æ–°');
      autoRefreshInterval = setInterval(() => {
        if (document.querySelector('.panel.active').id === 'environment-panel') {
          refreshEnvironment();
        }
      }, 5000);
    }
    
    function stopAutoRefresh() {
      log('åœæ­¢è‡ªåŠ¨åˆ·æ–°');
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }
    
    function toggleDebug() {
      debugMode = !debugMode;
      document.getElementById('debug-panel').classList.toggle('active');
      log(debugMode ? 'è°ƒè¯•é¢æ¿å·²å¼€å¯' : 'è°ƒè¯•é¢æ¿å·²å…³é—­');
    }
    
    function updateMemoryUsage() {
      if (performance.memory) {
        const used = Math.round(performance.memory.usedJSHeapSize / 1048576);
        document.getElementById('memory-usage').textContent = used;
      }
    }
    
    // æµ‹è¯•å¿«æ·åŠŸèƒ½
    function testEnvCheck() {
      log('æ‰§è¡Œç¯å¢ƒæ£€æµ‹æµ‹è¯•', 'INFO');
      refreshEnvironment();
    }
    
    function testConfigSave() {
      log('æ‰§è¡Œé…ç½®ä¿å­˜æµ‹è¯•', 'INFO');
      createNewConfig();
      setTimeout(saveConfig, 500);
    }
    
    function testClaudeStart() {
      log('æ‰§è¡Œ Claude å¯åŠ¨æµ‹è¯•', 'INFO');
      if (!claudeRunning) {
        startClaude();
      }
      setTimeout(() => {
        sendTestCommand('è¿™æ˜¯ä¸€æ¡è‡ªåŠ¨æµ‹è¯•æ¶ˆæ¯');
      }, 2000);
    }
    
    function simulateError() {
      log('æ¨¡æ‹Ÿé”™è¯¯çŠ¶æ€', 'ERROR');
      addToTerminal('[é”™è¯¯] è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„é”™è¯¯æ¶ˆæ¯', 'error');
      alert('é”™è¯¯ï¼šè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯ï¼');
    }
    
    function fillTestData() {
      log('å¡«å……æµ‹è¯•æ•°æ®', 'INFO');
      
      // å¡«å……é…ç½®
      document.getElementById('config-name').value = 'è‡ªåŠ¨å¡«å……é…ç½®';
      document.getElementById('config-apikey').value = 'sk-ant-test-' + Date.now();
      
      // æ·»åŠ æµ‹è¯•æ—¥å¿—
      for (let i = 0; i < 5; i++) {
        log(`æµ‹è¯•æ—¥å¿—æ¡ç›® ${i + 1}`, i % 2 === 0 ? 'INFO' : 'WARNING');
      }
      
      alert('æµ‹è¯•æ•°æ®å·²å¡«å……ï¼');
    }
    
    function runEnvTest() {
      log('è¿è¡Œå®Œæ•´ç¯å¢ƒæµ‹è¯•å¥—ä»¶', 'INFO');
      const tests = ['Node.js', 'Git', 'Claude', 'UV'];
      tests.forEach((test, index) => {
        setTimeout(() => {
          log(`æµ‹è¯• ${test}...`, 'INFO');
          refreshEnvironment();
        }, index * 1000);
      });
    }
    
    function runConfigTest() {
      log('è¿è¡Œé…ç½®æµ‹è¯•å¥—ä»¶', 'INFO');
      createNewConfig();
      setTimeout(() => {
        saveConfig();
        setTimeout(testConfig, 500);
      }, 500);
    }
    
    function runClaudeTest() {
      log('è¿è¡Œ Claude æµ‹è¯•å¥—ä»¶', 'INFO');
      if (!claudeRunning) {
        startClaude();
      }
      
      const testMessages = [
        'æµ‹è¯•æ¶ˆæ¯1ï¼šä½ å¥½',
        'æµ‹è¯•æ¶ˆæ¯2ï¼šè¯·å¸®æˆ‘å†™ä»£ç ',
        'æµ‹è¯•æ¶ˆæ¯3ï¼šè§£é‡Šä¸€ä¸‹é‡å­è®¡ç®—'
      ];
      
      testMessages.forEach((msg, index) => {
        setTimeout(() => {
          sendTestCommand(msg);
        }, 2000 + index * 2000);
      });
    }
    
    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + D åˆ‡æ¢è°ƒè¯•
      if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
        e.preventDefault();
        toggleDebug();
      }
      
      // Ctrl/Cmd + T è¿è¡Œæµ‹è¯•
      if ((e.ctrlKey || e.metaKey) && e.key === 't') {
        e.preventDefault();
        testClaudeStart();
      }
      
      // Ctrl/Cmd + R åˆ·æ–°ï¼ˆä»…åœ¨ç¯å¢ƒé¢æ¿ï¼‰
      if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        if (document.querySelector('.panel.active').id === 'environment-panel') {
          refreshEnvironment();
        }
      }
    });
    
    // é¡µé¢åŠ è½½å®Œæˆå
    log('æµ‹è¯•æ¨¡å¼å‡†å¤‡å°±ç»ª', 'INFO');
    log('å¿«æ·é”®: Ctrl+D=è°ƒè¯•, Ctrl+T=æµ‹è¯•, Ctrl+R=åˆ·æ–°', 'INFO');
  </script>
</body>
</html>