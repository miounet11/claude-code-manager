<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Miaoda - Claude Code Manager</title>
  <link rel="stylesheet" href="styles/welcome-guide.css">
  <link rel="stylesheet" href="styles/config-form.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      overflow: hidden;
      font-size: 13px;
      line-height: 1.5;
    }
    
    /* ä¾§è¾¹æ  */
    .sidebar {
      width: 180px;
      background: #252525;
      border-right: 1px solid #3e3e3e;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid #3e3e3e;
    }
    
    .logo {
      font-size: 1.2em;
      font-weight: bold;
      color: #0dbc79;
    }
    
    .nav-menu {
      flex: 1;
      padding: 8px 0;
    }
    
    .nav-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .nav-item:hover {
      background: #2d2d2d;
    }
    
    .nav-item.active {
      background: #2d2d2d;
      border-left: 3px solid #0dbc79;
    }
    
    /* ä¸»å†…å®¹åŒº */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: #2d2d2d;
      padding: 15px 20px;
      border-bottom: 1px solid #3e3e3e;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h2 {
      font-size: 16px;
      font-weight: 500;
      margin: 0;
    }
    
    .content {
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    
    /* é¢æ¿åˆ‡æ¢ */
    .panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: none;
      overflow-y: auto;
      padding: 20px;
    }
    
    .panel.active {
      display: block;
    }
    
    /* ç¯å¢ƒæ£€æµ‹é¢æ¿ */
    .env-card {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .env-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #3e3e3e;
    }
    
    .env-item:last-child {
      border-bottom: none;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.9em;
    }
    
    .status-badge.success {
      background: #0dbc7933;
      color: #0dbc79;
    }
    
    .status-badge.error {
      background: #cd313133;
      color: #cd3131;
    }
    
    /* é…ç½®ç®¡ç†é¢æ¿ */
    .config-container {
      display: flex;
      gap: 20px;
      height: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .config-list {
      width: 300px;
      background: #2d2d2d;
      border-radius: 8px;
      padding: 20px;
      overflow-y: auto;
      max-height: 100%;
    }
    
    .config-item {
      padding: 12px;
      margin-bottom: 8px;
      background: #252525;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .config-item:hover {
      background: #3e3e3e;
    }
    
    .config-item.active {
      background: #0dbc7933;
      border: 1px solid #0dbc79;
    }
    
    .config-editor {
      flex: 1;
      background: #2d2d2d;
      border-radius: 8px;
      padding: 20px;
      overflow-y: auto;
      max-height: 100%;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 13px;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px 12px;
      background: #1e1e1e;
      border: 1px solid #3e3e3e;
      border-radius: 4px;
      color: #d4d4d4;
      font-family: inherit;
      font-size: 13px;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #0dbc79;
    }
    
    
    .shortcut-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 12px;
    }
    
    .shortcut-key {
      background: #21262d;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      color: #f0f6fc;
    }
    
    /* æŒ‰é’® */
    button {
      background: #0dbc79;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      font-family: inherit;
    }
    
    button:hover {
      background: #0ba568;
    }
    
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    
    button.secondary {
      background: #3e3e3e;
    }
    
    button.secondary:hover {
      background: #4e4e4e;
    }
    
    button.danger {
      background: #cd3131;
    }
    
    button.danger:hover {
      background: #a02020;
    }
    
    /* ä¸»è¦æŒ‰é’®æ ·å¼ */
    button.btn-primary {
      background: #0dbc79;
      color: white;
      font-weight: 500;
    }
    
    button.btn-primary:hover {
      background: #0ba568;
    }
    
    /* æŒ‰é’®å†…çš„å›¾æ ‡ */
    button i {
      margin-right: 6px;
      font-style: normal;
    }
    
    /* è­¦å‘ŠæŒ‰é’®æ ·å¼ */
    button.btn-warning {
      background: #f0ad4e;
      color: white;
    }
    
    button.btn-warning:hover {
      background: #ec971f;
    }
    
    /* æˆåŠŸæŒ‰é’®æ ·å¼ */
    button.btn-success {
      background: #5cb85c;
      color: white;
    }
    
    button.btn-success:hover {
      background: #449d44;
    }
    
    /* å›¾æ ‡å®šä¹‰ */
    .icon-save::before { content: 'ğŸ’¾'; }
    .icon-test::before { content: 'ğŸ§ª'; }
    .icon-trash::before { content: 'ğŸ—‘ï¸'; }
    .icon-restore::before { content: 'ğŸ”„'; }
    .icon-check::before { content: 'âœ…'; }
    
    /* çŠ¶æ€æ  */
    .status-bar {
      background: #252525;
      border-top: 1px solid #3e3e3e;
      padding: 8px 16px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }
    
    .status-dot.active {
      background: #0dbc79;
    }
    
    /* å·¥å…·æç¤º */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #3e3e3e;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.9em;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* åŠ¨ç”» */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .spinner {
      border: 2px solid #3e3e3e;
      border-top: 2px solid #0dbc79;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* æ‰“å­—æŒ‡ç¤ºå™¨åŠ¨ç”» */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }
    
    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #58a6ff;
      opacity: 0.6;
      animation: typing 1.4s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.6;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }
    
    /* å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 768px) {
      .sidebar {
        width: 160px;
      }
      
      .nav-item {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .panel {
        padding: 15px;
      }
      
      button {
        padding: 6px 12px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- ä¾§è¾¹æ  -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo">Miaoda</div>
    </div>
    
    <!-- ä»£ç†çŠ¶æ€å¡ç‰‡ -->
    <div id="proxy-status-card" class="proxy-status-card" style="display: none;">
      <div class="proxy-status-header">
        <div class="proxy-status-title">
          <span class="status-indicator"></span>
          <span>ä»£ç†çŠ¶æ€</span>
        </div>
      </div>
      <div class="proxy-status-info">
        <div class="status-item">
          <span class="status-item-label">ç«¯å£:</span>
          <span class="status-item-value" id="status-port">8082</span>
        </div>
        <div class="status-item">
          <span class="status-item-label">æ¨¡å‹:</span>
          <span class="status-item-value" id="status-model">æœªé…ç½®</span>
        </div>
        <div class="status-item">
          <span class="status-item-label">çŠ¶æ€:</span>
          <span class="status-item-value" id="status-state">æœªå¯åŠ¨</span>
        </div>
      </div>
      <div class="quick-actions">
        <button class="quick-action-btn" onclick="quickRestart()">
          <span>ğŸ”„</span>
          <span>é‡å¯</span>
        </button>
        <button class="quick-action-btn danger" onclick="quickStop()">
          <span>â¹</span>
          <span>åœæ­¢</span>
        </button>
      </div>
    </div>
    
    <!-- æ¨¡å‹åˆ‡æ¢å™¨ -->
    <div class="model-switcher">
      <div class="model-switcher-title">å¿«é€Ÿåˆ‡æ¢æ¨¡å‹</div>
      <select class="model-select" id="quick-model-select" onchange="quickSwitchModel(this.value)">
        <option value="">é€‰æ‹©æ¨¡å‹...</option>
        <option value="claude-opus-4-1-20250805">Claude Opus 4</option>
        <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
        <option value="gpt-4o">GPT-4o</option>
        <option value="grok-4">Grok 4</option>
        <option value="custom">è‡ªå®šä¹‰...</option>
      </select>
    </div>
    
    <nav class="nav-menu">
      <div class="nav-item active" onclick="showPanel('environment', event)">
        <span>ğŸŒ</span>
        <span>ç¯å¢ƒæ£€æµ‹</span>
      </div>
      <div class="nav-item" onclick="showPanel('config', event)">
        <span>âš™ï¸</span>
        <span>é…ç½®ç®¡ç†</span>
      </div>
      
    </nav>
  </div>
  
  <!-- ä¸»å†…å®¹ -->
  <div class="main-content">
    <div class="header">
      <h2 id="panel-title">ç¯å¢ƒæ£€æµ‹</h2>
      <div id="header-actions">
        <button onclick="refreshEnvironment()">åˆ·æ–°</button>
      </div>
    </div>
    
    <div class="content">
      <!-- ç¯å¢ƒæ£€æµ‹é¢æ¿ -->
      <div id="environment-panel" class="panel active">
        <div class="env-card">
          <h3 style="margin-bottom: 20px;">ç³»ç»Ÿä¾èµ–</h3>
          
          <div class="env-item">
            <div class="env-name">Node.js</div>
            <div class="env-status">
              <span id="nodejs-version">æ£€æµ‹ä¸­...</span>
              <span id="nodejs-status" class="status-badge">æ£€æµ‹ä¸­</span>
            </div>
          </div>
          
          <div class="env-item">
            <div class="env-name">Git</div>
            <div class="env-status">
              <span id="git-version">æ£€æµ‹ä¸­...</span>
              <span id="git-status" class="status-badge">æ£€æµ‹ä¸­</span>
            </div>
          </div>
          
          <div class="env-item">
            <div class="env-name">Claude CLI</div>
            <div class="env-status">
              <span id="claude-version">æ£€æµ‹ä¸­...</span>
              <span id="claude-status" class="status-badge">æ£€æµ‹ä¸­</span>
              <button id="claude-install-btn" style="display: none; margin-left: 10px; padding: 4px 12px; font-size: 12px;" onclick="installDependency('claude')">å®‰è£…</button>
            </div>
          </div>
          
          <div class="env-item">
            <div class="env-name">UV (Python)</div>
            <div class="env-status">
              <span id="uv-version">æ£€æµ‹ä¸­...</span>
              <span id="uv-status" class="status-badge">æ£€æµ‹ä¸­</span>
              <button id="uv-install-btn" style="display: none; margin-left: 10px; padding: 4px 12px; font-size: 12px;" onclick="installDependency('uv')">å®‰è£…</button>
            </div>
          </div>
        </div>
        
        <div class="env-card">
          <h3 style="margin-bottom: 20px;">ç³»ç»Ÿä¿¡æ¯</h3>
          <div id="system-info">
            <p>åŠ è½½ä¸­...</p>
          </div>
        </div>
      </div>
      
      <!-- é…ç½®ç®¡ç†é¢æ¿ -->
      <div id="config-panel" class="panel">
        <div class="config-container">
          <div class="config-list">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3>é…ç½®åˆ—è¡¨</h3>
              <button onclick="createNewConfig()" style="padding: 6px 12px; font-size: 12px;">æ–°å»º</button>
            </div>
            <div id="config-list-items">
              <!-- é…ç½®é¡¹å°†åŠ¨æ€åŠ è½½ -->
            </div>
          </div>
          
          <div class="config-editor">
            <div class="config-card">
              <div class="config-card-header">
                <h3 class="config-card-title">ç¼–è¾‘é…ç½®</h3>
                <span class="config-card-badge" id="config-status-badge">æœªä¿å­˜</span>
              </div>
              
              <form id="config-form">
                <!-- æ¨¡å¼åˆ‡æ¢ -->
                <div class="mode-switch-container">
                  <div class="mode-switch-item">
                    <input type="radio" name="config-mode" id="mode-claude" checked>
                    <label for="mode-claude">Claude å®˜æ–¹</label>
                  </div>
                  <div class="mode-switch-item">
                    <input type="radio" name="config-mode" id="mode-openai">
                    <label for="mode-openai">OpenAI å…¼å®¹</label>
                  </div>
                </div>
                
                <!-- ä¸¤åˆ—è¡¨å•å¸ƒå±€ -->
                <div class="config-form-grid">
                  <div class="form-group">
                    <label>é…ç½®åç§°</label>
                    <input type="text" id="config-name" placeholder="æˆ‘çš„é…ç½®">
                  </div>
                  
                  <div class="form-group">
                    <label>æ¨¡å‹é€‰æ‹©</label>
                    <input type="text" id="config-model" list="model-options" placeholder="é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹">
                    <datalist id="model-options">
                      <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet</option>
                      <option value="claude-3-7-sonnet-20250219-thinking">Claude 3.7 Sonnet (Thinking)</option>
                      <option value="grok-3claude-sonnet-4-20250514">Grok 3 Claude Sonnet 4</option>
                      <option value="claude-opus-4-20250514">Claude Opus 4</option>
                      <option value="claude-opus-4-1-20250805">Claude Opus 4.1</option>
                      <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                      <option value="claude-3-opus-20240229">Claude 3 Opus (Legacy)</option>
                      <option value="claude-3-sonnet-20240229">Claude 3 Sonnet (Legacy)</option>
                      <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                    </datalist>
                  </div>
                  
                  <div class="form-group full-width">
                    <label>API Key</label>
                    <div class="api-key-input-wrapper">
                      <input type="password" id="config-apikey" placeholder="sk-...">
                      <button type="button" class="api-key-toggle" onclick="toggleApiKeyVisibility()">
                        <span id="api-key-toggle-icon">ğŸ‘</span>
                      </button>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label>API URL</label>
                    <input type="url" id="config-apiurl" placeholder="https://api.anthropic.com">
                  </div>
                  
                  <div class="form-group">
                    <label>æœ€å¤§è¾“å‡ºä»¤ç‰Œæ•°</label>
                    <input type="number" id="config-maxtokens" min="1" max="200000" value="32000" placeholder="32000">
                    <small>æ¨èå€¼: 32000</small>
                  </div>
                  
                  <div class="form-group">
                    <label>ä»£ç†è®¾ç½®</label>
                    <input type="text" id="config-proxy" placeholder="http://proxy.example.com:8080">
                    <small>å¯é€‰ï¼Œç•™ç©ºåˆ™ä¸ä½¿ç”¨</small>
                  </div>
                  
                  <div class="form-group">
                    <label>è¯·æ±‚è¶…æ—¶(ç§’)</label>
                    <input type="number" id="config-timeout" min="10" max="300" value="90" placeholder="90">
                    <small>é»˜è®¤: 90ç§’</small>
                  </div>
                  
                  <div class="form-group full-width" style="display: flex; align-items: center; gap: 12px;">
                    <input type="checkbox" id="toggle-internal-proxy" style="width: auto;">
                    <label for="toggle-internal-proxy" style="margin: 0; cursor: pointer;">å¯ç”¨å†…éƒ¨ä»£ç†æœåŠ¡å™¨</label>
                  </div>
                </div>
                
                <!-- OpenAI å…¼å®¹æ¨¡å¼è®¾ç½®ï¼ˆå¯æŠ˜å ï¼‰ -->
                <div id="openai-section" style="display: none; margin-top: 20px;">
                  <div class="config-form-grid">
                    <div class="form-group">
                      <label>OpenAI Base URL</label>
                      <input type="url" id="config-openai-baseurl" placeholder="https://api.openai.com/v1">
                    </div>
                    
                    <div class="form-group">
                      <label>OpenAI API Key</label>
                      <input type="password" id="config-openai-apikey" placeholder="sk-...">
                    </div>
                    
                    <div class="form-group">
                      <label>å¤§æ¨¡å‹æ˜ å°„</label>
                      <input type="text" id="config-big-model" placeholder="gpt-4o">
                    </div>
                    
                    <div class="form-group">
                      <label>å°æ¨¡å‹æ˜ å°„</label>
                      <input type="text" id="config-small-model" placeholder="gpt-4o-mini">
                    </div>
                  </div>
                </div>
              </form>
              
              <!-- æ“ä½œæŒ‰é’® -->
              <div class="config-actions">
                <button type="button" class="primary" onclick="saveConfigAndStart()">
                  <span>ğŸ’¾</span>
                  <span>ä¿å­˜å¹¶å¯åŠ¨</span>
                </button>
                <button type="button" class="primary" onclick="saveConfigAndStartProxy()">
                  <span>ğŸš€</span>
                  <span>ä¿å­˜å¹¶å¯åŠ¨ä»£ç†</span>
                </button>
                <button type="button" class="secondary" onclick="testConfig()">
                  <span>ğŸ”</span>
                  <span>æµ‹è¯•è¿æ¥</span>
                </button>
                <button type="button" class="secondary" onclick="saveConfig()">
                  <span>âœ…</span>
                  <span>ä»…ä¿å­˜</span>
                </button>
                <button type="button" class="danger" onclick="deleteConfig()">
                  <span>ğŸ—‘</span>
                  <span>åˆ é™¤é…ç½®</span>
                </button>
              </div>
            </div>
              
              <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                <button type="button" class="btn-primary" onclick="deployClaudeProxy()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100%; font-size: 16px; padding: 12px;">
                  <i class="icon icon-rocket"></i>
                  ğŸš€ ä¸€é”®éƒ¨ç½² Claude Code Proxy
                </button>
                <div id="deploy-progress" style="margin-top: 10px; display: none;">
                  <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 4px; padding: 10px; max-height: 200px; overflow-y: auto;">
                    <div id="deploy-messages"></div>
                  </div>
                </div>
              </div>
              
              <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                <button type="button" class="btn-warning" onclick="restoreDefaultConfig()">
                  <i class="icon icon-restore"></i>
                  è¿˜åŸ Claude Code å®˜æ–¹é…ç½®
                </button>
              </div>

              <!-- ä»£ç†è¿è¡Œä¿¡æ¯æç¤ºï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œå¯å¤åˆ¶ï¼‰ -->
              <div id="proxy-info" style="display:none; margin-top: 14px; padding: 12px; border: 1px solid #3e3e3e; border-radius: 6px; background:#252525;">
                <div style="font-weight:500; margin-bottom:6px;">ä»£ç†å·²å¯åŠ¨</div>
                <div id="proxy-info-lines" style="color:#bdbdbd; font-size:12px; line-height:1.6;"></div>
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                  <button type="button" class="secondary" id="btn-copy-proxy-url">å¤åˆ¶ä»£ç†åœ°å€</button>
                  <button type="button" class="secondary" id="btn-copy-env">å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      
    </div>
    
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
      <div class="status-indicator">
        <span>ç‰ˆæœ¬: <span id="app-version">2.1.0</span></span>
      </div>
      <div class="status-indicator">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">å°±ç»ª</span>
      </div>
    </div>
  </div>
  
  <!-- xterm.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
  <script>
    // ä¸ºæ‰€æœ‰æœ¬åœ°è„šæœ¬æ·»åŠ ç‰ˆæœ¬å·ä»¥é˜²æ­¢ç¼“å­˜
    const scriptVersion = new Date().getTime();
    
    function loadScript(src) {
      const script = document.createElement('script');
      script.src = src + '?v=' + scriptVersion;
      document.body.appendChild(script);
      return new Promise((resolve) => {
        script.onload = resolve;
      });
    }
    
    // å·²ç§»é™¤ç»ˆç«¯åŠŸèƒ½
  </script>
  
  <script>
    // å…¨å±€çŠ¶æ€
    let currentPanel = 'environment';
    let currentConfig = null;
    let claudeRunning = false;
    let configs = [];
    
    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      initializeApp();
    });
    
    async function initializeApp() {
      // è·å–ç‰ˆæœ¬
      try {
        const version = await window.electronAPI.getVersion();
        document.getElementById('app-version').textContent = version;
      } catch (error) {
        console.error('è·å–ç‰ˆæœ¬å¤±è´¥:', error);
      }
      
      // åŠ è½½åˆå§‹æ•°æ®
      refreshEnvironment();
      loadConfigs();
      
      // æ¨¡å¼é€‰æ‹©è”åŠ¨
      const modeClaude = document.getElementById('mode-claude');
      const modeOpenAI = document.getElementById('mode-openai');
      const openaiSection = document.getElementById('openai-section');
      const toggleInternal = document.getElementById('toggle-internal-proxy');
      const mainApiUrl = document.getElementById('config-apiurl');
      const mainApiKey = document.getElementById('config-apikey');
      // å°† OpenAI å¼•ç”¨ç»Ÿä¸€æŒ‡å‘ä¸»è¾“å…¥ï¼Œé¿å…é‡å¤å­—æ®µ
      const openaiBase = mainApiUrl;
      const openaiKey = mainApiKey;
      // éšè—æ—§çš„ OPENAI_BASE_URL/OPENAI_API_KEY å­—æ®µåˆ†ç»„
      const openaiBaseGrp = document.getElementById('config-openai-base-url')?.closest('.form-group');
      const openaiKeyGrp = document.getElementById('config-openai-api-key')?.closest('.form-group');
      if (openaiBaseGrp) openaiBaseGrp.style.display = 'none';
      if (openaiKeyGrp) openaiKeyGrp.style.display = 'none';

      function applyMode(openaiEnabled) {
        if (openaiSection) openaiSection.style.display = openaiEnabled ? 'block' : 'none';
        [openaiBase, openaiKey, smallModel, middleModel, bigModel].forEach(el => el && (el.disabled = !openaiEnabled));
        if (toggleInternal && openaiEnabled) toggleInternal.checked = true;
      }

      if (modeClaude && modeOpenAI) {
        modeClaude.addEventListener('change', () => applyMode(!modeClaude.checked));
        modeOpenAI.addEventListener('change', () => applyMode(modeOpenAI.checked));
      }

      // ä¸€é”®ç¤ºä¾‹æŒ‰é’®
      const btnOpenAI = document.getElementById('btn-preset-openai');
      const btnAzure = document.getElementById('btn-preset-azure');
      const btnOllama = document.getElementById('btn-preset-ollama');
      const btnClear = document.getElementById('btn-clear-openai');
      if (btnOpenAI) btnOpenAI.addEventListener('click', () => {
        if (openaiBase) openaiBase.value = 'https://api.openai.com/v1';
        if (smallModel) smallModel.value = 'gpt-4o-mini';
        if (middleModel) middleModel.value = 'gpt-4o';
        if (bigModel) bigModel.value = 'gpt-4o';
        if (modeOpenAI && !modeOpenAI.checked) modeOpenAI.checked = true, applyMode(true);
      });
      if (btnAzure) btnAzure.addEventListener('click', () => {
        if (openaiBase) openaiBase.value = 'https://your-resource.openai.azure.com/openai/deployments/your-deployment';
        if (smallModel) smallModel.value = 'gpt-35-turbo';
        if (middleModel) middleModel.value = 'gpt-4';
        if (bigModel) bigModel.value = 'gpt-4';
        if (modeOpenAI && !modeOpenAI.checked) modeOpenAI.checked = true, applyMode(true);
      });
      if (btnOllama) btnOllama.addEventListener('click', () => {
        if (openaiBase) openaiBase.value = 'http://localhost:11434/v1';
        if (smallModel) smallModel.value = 'llama3.1:8b';
        if (middleModel) middleModel.value = 'llama3.1:70b';
        if (bigModel) bigModel.value = 'llama3.1:70b';
        if (modeOpenAI && !modeOpenAI.checked) modeOpenAI.checked = true, applyMode(true);
      });
      if (btnClear) btnClear.addEventListener('click', () => {
        if (openaiBase) openaiBase.value = '';
        if (openaiKey) openaiKey.value = '';
      });
      
      // ç›‘å¬ Claude è¾“å‡º
      window.electronAPI.onClaudeOutput((data) => {
        if (data.type === 'raw') {
          // å¤„ç†åŸå§‹ç»ˆç«¯è¾“å‡º
          addToTerminal(data.text, 'raw');
        } else if (data.type === 'system') {
          addToTerminal(data.text, 'system', 'ğŸ”„');
        } else if (data.type === 'error') {
          addToTerminal(data.text, 'error', 'âŒ');
        } else {
          // å…¶ä»–è¾“å‡ºä½œä¸ºæ™®é€šæ–‡æœ¬å¤„ç†
          addToTerminal(data.text, 'claude');
        }
      });
      
      // å·²ç§»é™¤ç»ˆç«¯è¾“å…¥å¤„ç†
    }
    
    // é¢æ¿åˆ‡æ¢
    async function showPanel(panelName, event) {
      // æ›´æ–°å¯¼èˆªæ 
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // å¦‚æœæœ‰äº‹ä»¶å¯¹è±¡ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™æ ¹æ® panelName æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªé¡¹
      if (event && event.currentTarget) {
        event.currentTarget.classList.add('active');
      } else {
        // æ ¹æ® panelName æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªé¡¹
        const navItems = document.querySelectorAll('.nav-item');
        const panelIndex = panelName === 'environment' ? 0 : panelName === 'config' ? 1 : 2;
        if (navItems[panelIndex]) {
          navItems[panelIndex].classList.add('active');
        }
      }
      
      // æ›´æ–°é¢æ¿
      document.querySelectorAll('.panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.getElementById(`${panelName}-panel`).classList.add('active');
      
      // æ›´æ–°æ ‡é¢˜å’Œæ“ä½œæŒ‰é’®
      const titles = {
        environment: 'ç¯å¢ƒæ£€æµ‹',
        config: 'é…ç½®ç®¡ç†',
        terminal: 'ç»ˆç«¯'
      };
      document.getElementById('panel-title').textContent = titles[panelName];
      
      // å·²ç§»é™¤ç»ˆç«¯é¢æ¿åˆå§‹åŒ–
      
      // æ›´æ–°å¤´éƒ¨æ“ä½œæŒ‰é’®
      const headerActions = document.getElementById('header-actions');
      if (panelName === 'environment') {
        headerActions.innerHTML = '<button onclick="refreshEnvironment()">åˆ·æ–°</button>';
      } else {
        headerActions.innerHTML = '';
      }
      
      currentPanel = panelName;
    }
    
    // ç¯å¢ƒæ£€æµ‹
    async function refreshEnvironment() {
      try {
        // è°ƒç”¨çœŸå®çš„ç¯å¢ƒæ£€æµ‹
        const envData = await window.electronAPI.checkEnvironment();
        
        // æ›´æ–°æ˜¾ç¤º
        Object.entries(envData).forEach(([key, data]) => {
          const versionEl = document.getElementById(`${key}-version`);
          const statusEl = document.getElementById(`${key}-status`);
          const installBtn = document.getElementById(`${key}-install-btn`);
          
          if (data.installed) {
            versionEl.textContent = data.version;
            statusEl.className = 'status-badge success';
            statusEl.textContent = 'å·²å®‰è£…';
            if (installBtn) installBtn.style.display = 'none';
          } else {
            versionEl.textContent = 'æœªå®‰è£…';
            statusEl.className = 'status-badge error';
            statusEl.textContent = 'æœªå®‰è£…';
            if (installBtn) installBtn.style.display = 'inline-block';
          }
        });
        
        // ç³»ç»Ÿä¿¡æ¯
        document.getElementById('system-info').innerHTML = `
          <p>å¹³å°: ${window.electronAPI.platform === 'darwin' ? 'macOS' : 
                    window.electronAPI.platform === 'win32' ? 'Windows' : 'Linux'}</p>
          <p>æ¶æ„: ${window.electronAPI.platform === 'darwin' ? 
                    (navigator.userAgent.includes('ARM') ? 'arm64' : 'x64') : 'x64'}</p>
          <p>Electron: ${navigator.userAgent.match(/Electron\/(\S+)/)?.[1] || '30.0.0'}</p>
          <p>Node.js: å†…ç½®</p>
        `;
      } catch (error) {
        console.error('ç¯å¢ƒæ£€æµ‹å¤±è´¥:', error);
        addToTerminal('[é”™è¯¯] ç¯å¢ƒæ£€æµ‹å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // å®‰è£…ä¾èµ–
    async function installDependency(dependency) {
      try {
        const btn = document.getElementById(`${dependency}-install-btn`);
        btn.disabled = true;
        btn.textContent = 'å®‰è£…ä¸­...';
        
        // ç›‘å¬å®‰è£…è¿›åº¦
        window.electronAPI.onInstallProgress((data) => {
          if (data.dependency === dependency) {
            if (data.status === 'completed') {
              btn.textContent = 'å®‰è£…æˆåŠŸ';
              setTimeout(() => {
                refreshEnvironment();
              }, 2000);
            } else if (data.status === 'failed') {
              btn.textContent = 'å®‰è£…å¤±è´¥';
              btn.disabled = false;
              addToTerminal(`[é”™è¯¯] ${dependency} å®‰è£…å¤±è´¥: ${data.message}`, 'error');
            } else {
              // æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
              console.log(data.message);
            }
          }
        });
        
        // å¼€å§‹å®‰è£…
        await window.electronAPI.installDependency(dependency);
      } catch (error) {
        console.error('å®‰è£…å¤±è´¥:', error);
        const btn = document.getElementById(`${dependency}-install-btn`);
        btn.disabled = false;
        btn.textContent = 'å®‰è£…';
        addToTerminal(`[é”™è¯¯] å®‰è£…å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    // é…ç½®ç®¡ç†
    async function loadConfigs() {
      try {
        // ä»æœ¬åœ°åŠ è½½é…ç½®
        console.log('[loadConfigs] å¼€å§‹åŠ è½½é…ç½®...');
        configs = await window.electronAPI.getAllConfigs();
        console.log('[loadConfigs] åŠ è½½åˆ°çš„é…ç½®:', configs);
        
        renderConfigList();
        if (configs.length > 0) {
          // è·å–å½“å‰é€‰ä¸­çš„é…ç½®
          const current = await window.electronAPI.getCurrentConfig();
          selectConfig(current || configs[0]);
        }
      } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
        configs = [];
      }
    }
    
    function renderConfigList() {
      const listEl = document.getElementById('config-list-items');
      console.log('[renderConfigList] æ¸²æŸ“é…ç½®åˆ—è¡¨, é…ç½®æ•°é‡:', configs.length);
      console.log('[renderConfigList] åˆ—è¡¨å…ƒç´ :', listEl);
      
      if (!listEl) {
        console.error('[renderConfigList] æ‰¾ä¸åˆ° config-list-items å…ƒç´ !');
        return;
      }
      
      listEl.innerHTML = configs.map(config => `
        <div class="config-item ${currentConfig?.id === config.id ? 'active' : ''}" 
             onclick="selectConfig(${JSON.stringify(config).replace(/"/g, '&quot;')})">
          <div style="display: flex; align-items: center; gap: 5px;">
            ${config.isFreeAccount ? '<span style="background: #0dbc79; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">å…è´¹</span>' : ''}
            <span style="font-weight: 500;">${config.name}</span>
          </div>
          <div style="font-size: 0.9em; color: #666; margin-top: 4px;">
            ${config.model}
            ${config.isFreeAccount ? ' â€¢ æ¯æ—¥é™é¢' : ''}
          </div>
        </div>
      `).join('');
    }
    
    function selectConfig(config) {
      currentConfig = config;
      document.getElementById('config-name').value = config.name;
      document.getElementById('config-apikey').value = config.apiKey;
      document.getElementById('config-apiurl').value = config.apiUrl || 'https://api.anthropic.com';
      document.getElementById('config-model').value = config.model;
      document.getElementById('config-proxy').value = config.proxy || '';
      document.getElementById('config-maxtokens').value = config.maxTokens || 32000;
      // æ¨¡å¼ä¸ OpenAI è®¾ç½®å›å¡«
      const modeClaude = document.getElementById('mode-claude');
      const modeOpenAI = document.getElementById('mode-openai');
      const openaiSection = document.getElementById('openai-section');
      const toggleInternal = document.getElementById('toggle-internal-proxy');
      const openaiBase = document.getElementById('config-openai-base-url');
      const openaiKey = document.getElementById('config-openai-api-key');
      const mainApiUrl = document.getElementById('config-apiurl');
      const mainApiKey = document.getElementById('config-apikey');
      const smallModel = document.getElementById('config-small-model');
      const middleModel = document.getElementById('config-middle-model');
      const bigModel = document.getElementById('config-big-model');

      const openaiEnabled = !!config.openaiBaseUrl;
      if (modeClaude && modeOpenAI) {
        modeOpenAI.checked = openaiEnabled;
        modeClaude.checked = !openaiEnabled;
      }
      if (openaiSection) openaiSection.style.display = openaiEnabled ? 'block' : 'none';
      if (toggleInternal) toggleInternal.checked = !!config.useInternalProxy || openaiEnabled;
      if (openaiEnabled) {
        if (mainApiUrl) mainApiUrl.value = config.openaiBaseUrl || '';
        if (mainApiKey) mainApiKey.value = config.openaiApiKey || '';
      } else {
        if (mainApiUrl && config.apiUrl) mainApiUrl.value = config.apiUrl;
        if (mainApiKey && config.apiKey) mainApiKey.value = config.apiKey;
        currentConfig.openaiBaseUrl = '';
        currentConfig.openaiApiKey = '';
      }
      if (smallModel) smallModel.value = config.smallModel || 'gpt-4o-mini';
      if (middleModel) middleModel.value = config.middleModel || 'gpt-4o';
      if (bigModel) bigModel.value = config.bigModel || 'gpt-4o';

      // å¦‚æœæ˜¯å…è´¹è´¦æˆ·ï¼Œç¦ç”¨æŸäº›å­—æ®µ
      const isReadOnly = config.isFreeAccount;
      document.getElementById('config-name').readOnly = isReadOnly;
      document.getElementById('config-apikey').readOnly = isReadOnly;
      document.getElementById('config-apiurl').readOnly = isReadOnly;
      document.getElementById('config-model').readOnly = isReadOnly;
      
      // æ›´æ–°è¡¨å•æç¤º
      const form = document.getElementById('config-form');
      const existingNotice = form.querySelector('.free-account-notice');
      if (existingNotice) existingNotice.remove();
      
      if (isReadOnly) {
        const notice = document.createElement('div');
        notice.className = 'free-account-notice';
        notice.style.cssText = 'background: #0dbc7933; border: 1px solid #0dbc79; padding: 10px; border-radius: 6px; margin-bottom: 20px;';
        notice.innerHTML = '<div style="color: #0dbc79; font-weight: 500;">å…è´¹ä½“éªŒè´¦æˆ·</div><div style="color: #d4d4d4; font-size: 0.9em; margin-top: 5px;">æ­¤é…ç½®ä¸ºç³»ç»Ÿæä¾›çš„å…è´¹ä½“éªŒï¼Œéƒ¨åˆ†è®¾ç½®ä¸å¯ä¿®æ”¹ã€‚æ¯æ—¥é™é¢ 100ä¸‡ tokenã€‚</div>';
        form.insertBefore(notice, form.firstChild);
      }
      
      // æ›´æ–°æŒ‰é’®åŒºåŸŸï¼Œæ·»åŠ "ä½¿ç”¨æ­¤é…ç½®"æŒ‰é’®
      updateConfigButtons(config);
      
      renderConfigList();
    }
    
    function updateConfigButtons(config) {
      // è·å–å½“å‰é…ç½®
      window.electronAPI.getCurrentConfig().then(current => {
        const buttonArea = document.querySelector('#config-form > div:nth-last-child(2)');
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤º"ä½¿ç”¨æ­¤é…ç½®"æŒ‰é’®
        if (config && config.id && (!current || config.id !== current.id)) {
          // å¦‚æœæŒ‰é’®ä¸å­˜åœ¨ï¼Œæ·»åŠ å®ƒ
          let useBtn = document.getElementById('btn-use-config');
          if (!useBtn) {
            useBtn = document.createElement('button');
            useBtn.id = 'btn-use-config';
            useBtn.type = 'button';
            useBtn.className = 'btn-success';
            useBtn.innerHTML = '<i class="icon icon-check"></i> ä½¿ç”¨æ­¤é…ç½®';
            useBtn.onclick = () => useConfig();
            buttonArea.appendChild(useBtn);
          }
          useBtn.style.display = 'inline-block';
        } else {
          // éšè—æŒ‰é’®
          const useBtn = document.getElementById('btn-use-config');
          if (useBtn) {
            useBtn.style.display = 'none';
          }
        }
      });
    }
    
    async function useConfig() {
      if (!currentConfig || !currentConfig.id) return;
      
      try {
        await window.electronAPI.setCurrentConfig(currentConfig);
        // é‡æ–°åŠ è½½é…ç½®åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€
        await loadConfigs();
        window.electronAPI.showSuccess('é…ç½®å·²åˆ‡æ¢', `å·²åˆ‡æ¢åˆ°é…ç½®: ${currentConfig.name}`);
      } catch (error) {
        console.error('åˆ‡æ¢é…ç½®å¤±è´¥:', error);
        window.electronAPI.showError('åˆ‡æ¢å¤±è´¥', error.message);
      }
    }
    
    function createNewConfig() {
      const newConfig = {
        id: Date.now().toString(),
        name: 'æ–°é…ç½®',
        apiKey: '',
        apiUrl: 'https://api.anthropic.com',
        model: 'claude-3-7-sonnet-20250219',
        proxy: '',
        useInternalProxy: false, // æ–°å¢
        openaiBaseUrl: '', // æ–°å¢
        openaiApiKey: '', // æ–°å¢
        smallModel: 'gpt-4o-mini', // æ–°å¢
        middleModel: 'gpt-4o', // æ–°å¢
        bigModel: 'gpt-4o' // æ–°å¢
      };
      configs.push(newConfig);
      selectConfig(newConfig);
    }
    
    async function saveConfig() {
      if (!currentConfig) return;
      
      currentConfig.name = document.getElementById('config-name').value;
      currentConfig.apiKey = document.getElementById('config-apikey').value;
      currentConfig.apiUrl = document.getElementById('config-apiurl').value;
      currentConfig.model = document.getElementById('config-model').value;
      currentConfig.proxy = document.getElementById('config-proxy').value;
      currentConfig.maxTokens = parseInt(document.getElementById('config-maxtokens').value) || 32000;
      currentConfig.useInternalProxy = document.getElementById('toggle-internal-proxy')?.checked || false;
      // è®¾ç½® expectedAnthropicApiKey ä¸º 'api-key' (ä¸å‚è€ƒè„šæœ¬ä¸€è‡´)
      currentConfig.expectedAnthropicApiKey = 'api-key';
      // å°†ä¸»è¾“å…¥ä½œä¸ºç»Ÿä¸€å…¥å£ï¼›è‹¥ä¸º OpenAI æ¨¡å¼åˆ™èµ‹å€¼åˆ° openai å­—æ®µ
      const openaiSelected = document.getElementById('mode-openai')?.checked;
      const mainApiUrl = document.getElementById('config-apiurl')?.value.trim() || '';
      const mainApiKey = document.getElementById('config-apikey')?.value.trim() || '';
      if (openaiSelected) {
        currentConfig.openaiBaseUrl = mainApiUrl;
        currentConfig.openaiApiKey = mainApiKey;
        currentConfig.azureApiVersion = document.getElementById('config-azure-api-version')?.value.trim() || '';
      } else {
        currentConfig.apiUrl = mainApiUrl;
        currentConfig.apiKey = mainApiKey;
        currentConfig.openaiBaseUrl = '';
        currentConfig.openaiApiKey = '';
        currentConfig.azureApiVersion = '';
      }
      currentConfig.smallModel = document.getElementById('config-small-model')?.value.trim() || '';
      currentConfig.middleModel = document.getElementById('config-middle-model')?.value.trim() || '';
      currentConfig.bigModel = document.getElementById('config-big-model')?.value.trim() || '';
      
      try {
        // ä¿å­˜åˆ°æœ¬åœ°
        await window.electronAPI.saveConfig(currentConfig);
        await window.electronAPI.setCurrentConfig(currentConfig);
        
        // é‡æ–°åŠ è½½é…ç½®åˆ—è¡¨
        await loadConfigs();
        window.electronAPI.showSuccess('æˆåŠŸ', 'é…ç½®å·²ä¿å­˜ï¼');
      } catch (error) {
        console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
        window.electronAPI.showError('ä¿å­˜å¤±è´¥', error.message);
      }
    }
    
    async function saveConfigAndStart() {
      if (!currentConfig) return;
      
      // å…ˆä¿å­˜é…ç½®
      currentConfig.name = document.getElementById('config-name').value;
      currentConfig.apiKey = document.getElementById('config-apikey').value;
      currentConfig.apiUrl = document.getElementById('config-apiurl').value;
      currentConfig.model = document.getElementById('config-model').value;
      currentConfig.proxy = document.getElementById('config-proxy').value;
      currentConfig.maxTokens = parseInt(document.getElementById('config-maxtokens').value) || 32000;
      currentConfig.useInternalProxy = document.getElementById('toggle-internal-proxy')?.checked || false;
      // è®¾ç½® expectedAnthropicApiKey ä¸º 'api-key' (ä¸å‚è€ƒè„šæœ¬ä¸€è‡´)
      currentConfig.expectedAnthropicApiKey = 'api-key';
      // OpenAI/Claude ç»Ÿä¸€å…¥å£
      const openaiSelected2 = document.getElementById('mode-openai')?.checked;
      const mainApiUrl2 = document.getElementById('config-apiurl')?.value.trim() || '';
      const mainApiKey2 = document.getElementById('config-apikey')?.value.trim() || '';
      if (openaiSelected2) {
        currentConfig.openaiBaseUrl = mainApiUrl2;
        currentConfig.openaiApiKey = mainApiKey2;
        currentConfig.azureApiVersion = document.getElementById('config-azure-api-version')?.value.trim() || '';
      } else {
        currentConfig.apiUrl = mainApiUrl2;
        currentConfig.apiKey = mainApiKey2;
        currentConfig.openaiBaseUrl = '';
        currentConfig.openaiApiKey = '';
        currentConfig.azureApiVersion = '';
      }
      currentConfig.smallModel = document.getElementById('config-small-model')?.value.trim() || '';
      currentConfig.middleModel = document.getElementById('config-middle-model')?.value.trim() || '';
      currentConfig.bigModel = document.getElementById('config-big-model')?.value.trim() || '';
      
      try {
        // ä¿å­˜åˆ°æœ¬åœ°
        await window.electronAPI.saveConfig(currentConfig);
        await window.electronAPI.setCurrentConfig(currentConfig);
        
        // é‡æ–°åŠ è½½é…ç½®åˆ—è¡¨
        await loadConfigs();
        
        // å¯åŠ¨ä»£ç†
        let proxyPort = (typeof currentConfig.serverPort === 'number' ? currentConfig.serverPort : 8118);
        try {
          const started = await window.electronAPI.startProxy(currentConfig);
          if (started && started.success && started.port) {
            proxyPort = started.port;
          }
        } catch (e) {
          // å¯åŠ¨å¤±è´¥ä¹Ÿç»§ç»­æ˜¾ç¤ºæç¤ºï¼Œä½†ä¼šæç¤ºé”™è¯¯
        }

        // æ˜¾ç¤ºä»£ç†ä¿¡æ¯æç¤º
        const proxyInfo = document.getElementById('proxy-info');
        const lines = document.getElementById('proxy-info-lines');
        if (proxyInfo && lines) {
          const host = (currentConfig.serverHost || 'localhost');
          const url = `http://${host}:${proxyPort}`;
          const isOpenAI = !!currentConfig.openaiBaseUrl;
          const envSample = `ANTHROPIC_BASE_URL=${url}\nANTHROPIC_API_URL=${url}\nANTHROPIC_API_KEY=${currentConfig.expectedAnthropicApiKey || 'your-key'}`;
          lines.innerHTML = `
            <div>ä»£ç†åœ°å€: <code>${url}</code></div>
            <div>å·¥ä½œæ¨¡å¼: <code>${isOpenAI ? 'OpenAI å…¼å®¹ (Chat Completions)' : 'Claude å®˜æ–¹ (Messages)'}</code></div>
            <div>æˆ‘ä»¬å·²è‡ªåŠ¨å°† Claude ç¯å¢ƒå˜é‡æŒ‡å‘è¯¥ä»£ç†ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®ã€‚</div>
            <div id="request-preview-container" style="margin-top: 10px; display: none;">
              <div style="font-weight: bold; margin-bottom: 5px;">æœ€è¿‘è¯·æ±‚/å“åº”é¢„è§ˆ:</div>
              <pre id="request-preview" style="font-size: 11px; background: #f8f9fa; padding: 8px; border-radius: 4px; margin: 0; max-height: 150px; overflow-y: auto; white-space: pre-wrap;"></pre>
            </div>
          `;
          proxyInfo.style.display = 'block';
          const btnUrl = document.getElementById('btn-copy-proxy-url');
          const btnEnv = document.getElementById('btn-copy-env');
          if (btnUrl) btnUrl.onclick = () => navigator.clipboard.writeText(url);
          if (btnEnv) btnEnv.onclick = () => navigator.clipboard.writeText(envSample);
          // å†™å…¥åˆ°ç”¨æˆ· shell é…ç½®ï¼Œä¾¿äºä»»ä½•ç»ˆç«¯ç›´æ¥ä½¿ç”¨
          window.electronAPI.invoke ? null : null;
          if (window.electronAPI && window.electronAPI.getSystemInfo) {
            // é€šè¿‡é€šç”¨ invoke é€šé“è°ƒç”¨
            try {
              const apply = window.electronAPI && window.electronAPI.openExternal ? null : null;
            } catch (e) {}
          }
          // ç›´æ¥è°ƒç”¨ IPCï¼šenv:apply-global
          if (window.electronAPI && window.electronAPI.platform) {
            window.electronAPI
              .invoke
              ? null
              : null;
          }
          if (window.electronAPI && window.electronAPI.showInfo) {
            window.electronAPI
              .applyGlobalProxyEnv // å®é™…è°ƒç”¨
          }
          if (window.electronAPI && window.electronAPI.applyGlobalProxyEnv) {
            try {
              const result = await window.electronAPI.applyGlobalProxyEnv({
                baseUrl: url,
                expectedKey: currentConfig.expectedAnthropicApiKey || ''
              });
              if (result && result.success) {
                const files = (result.files || []).map(f => `<code>${f}</code>`).join(', ');
                lines.innerHTML += `<div>å·²å†™å…¥ç¯å¢ƒé…ç½®: ${files || 'ï¼ˆæœªæ£€æµ‹åˆ°å¯å†™å…¥çš„ shell é…ç½®ï¼‰'}</div>`;
              } else if (result && result.error) {
                lines.innerHTML += `<div>å†™å…¥ç¯å¢ƒå¤±è´¥: <code>${result.error}</code></div>`;
              }
            } catch (e) {
              lines.innerHTML += `<div>å†™å…¥ç¯å¢ƒå¼‚å¸¸: <code>${e.message}</code></div>`;
            }
          }
          
          // å¯åŠ¨è¯·æ±‚/å“åº”é¢„è§ˆæ›´æ–°
          startRequestPreviewUpdates(url);
        }
        // å¯åŠ¨ Claudeï¼ˆæ— éœ€æ˜¾ç¤ºç»ˆç«¯ï¼‰
        await startClaude();
        
      } catch (error) {
        console.error('ä¿å­˜å¹¶å¯åŠ¨å¤±è´¥:', error);
        window.electronAPI.showError('æ“ä½œå¤±è´¥', error.message);
      }
    }
    
    async function testConfig() {
      if (!currentConfig || !currentConfig.apiKey) {
        window.electronAPI.showError('é”™è¯¯', 'è¯·å…ˆé…ç½® API Keyï¼');
        return;
      }
      
      try {
        // æ˜¾ç¤ºæµ‹è¯•ä¸­çŠ¶æ€
        const testBtn = document.querySelector('button.secondary');
        const originalText = testBtn.textContent;
        testBtn.disabled = true;
        testBtn.textContent = 'æµ‹è¯•ä¸­...';
        
        // æ¨¡æ‹Ÿæµ‹è¯•å»¶è¿Ÿ
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // è¿™é‡Œåº”è¯¥å®é™…è°ƒç”¨ API æµ‹è¯•ï¼Œç°åœ¨å…ˆæ¨¡æ‹Ÿ
        const success = currentConfig.apiKey.startsWith('sk-');
        
        if (success) {
          window.electronAPI.showSuccess('æµ‹è¯•æˆåŠŸ', 'API Key æœ‰æ•ˆï¼Œé…ç½®æ­£ç¡®ï¼');
        } else {
          window.electronAPI.showError('æµ‹è¯•å¤±è´¥', 'è¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®ã€‚');
        }
        
        testBtn.disabled = false;
        testBtn.textContent = originalText;
      } catch (error) {
        console.error('æµ‹è¯•é…ç½®å¤±è´¥:', error);
        window.electronAPI.showError('æµ‹è¯•å¤±è´¥', error.message);
      }
    }
    
    async function deleteConfig() {
      if (!currentConfig) return;
      
      // ä¸å…è®¸åˆ é™¤å…è´¹ä½“éªŒé…ç½®
      if (currentConfig.isFreeAccount) {
        window.electronAPI.showError('æ— æ³•åˆ é™¤', 'å…è´¹ä½“éªŒé…ç½®ä¸èƒ½åˆ é™¤');
        return;
      }
      
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ')) return;
      
      try {
        await window.electronAPI.deleteConfig(currentConfig.id);
        await loadConfigs();
      } catch (error) {
        console.error('åˆ é™¤é…ç½®å¤±è´¥:', error);
        window.electronAPI.showError('åˆ é™¤å¤±è´¥', error.message);
      }
    }
    
    async function deployClaudeProxy() {
      const deployBtn = event.target.closest('button');
      const progressDiv = document.getElementById('deploy-progress');
      const messagesDiv = document.getElementById('deploy-messages');
      
      // ç¡®è®¤éƒ¨ç½²
      const confirm = await window.electronAPI.showConfirm(
        'ä¸€é”®éƒ¨ç½² Claude Code Proxy',
        'æ­¤åŠŸèƒ½å°†è‡ªåŠ¨ï¼š\n\n' +
        '1. å®‰è£… uv (Python åŒ…ç®¡ç†å™¨)\n' +
        '2. å®‰è£… Claude Code CLI\n' +
        '3. å…‹éš†å¹¶é…ç½® claude-code-proxy\n' +
        '4. å¯åŠ¨ä»£ç†æœåŠ¡ (ç«¯å£ 8082)\n' +
        '5. å¯åŠ¨ Claude Code\n\n' +
        'ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
      );
      
      if (!confirm) return;
      
      try {
        // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
        progressDiv.style.display = 'block';
        messagesDiv.innerHTML = '';
        deployBtn.disabled = true;
        deployBtn.innerHTML = '<i class="icon icon-loading"></i> éƒ¨ç½²ä¸­...';
        
        // æ·»åŠ è¿›åº¦æ¶ˆæ¯çš„å‡½æ•°
        const addMessage = (message, type = 'info') => {
          const msgEl = document.createElement('div');
          msgEl.style.cssText = `
            padding: 5px 0;
            color: ${type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#74c0fc'};
          `;
          msgEl.textContent = message;
          messagesDiv.appendChild(msgEl);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };
        
        // ç›‘å¬éƒ¨ç½²è¿›åº¦
        window.electronAPI.onProxyDeployProgress((data) => {
          if (data.step === 'complete') {
            addMessage('âœ… ' + data.message, 'success');
            deployBtn.disabled = false;
            deployBtn.innerHTML = 'âœ… éƒ¨ç½²å®Œæˆ';
            
            // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            if (data.details) {
              addMessage(`ä»£ç†åœ°å€: ${data.details.proxyUrl}`, 'info');
              addMessage(`æœ€å¤§ä»¤ç‰Œ: ${data.details.maxTokens}`, 'info');
              addMessage(`æ¨¡å‹: ${data.details.model}`, 'info');
            }
            
            // 3ç§’åæ¢å¤æŒ‰é’®
            setTimeout(() => {
              deployBtn.innerHTML = 'ğŸš€ ä¸€é”®éƒ¨ç½² Claude Code Proxy';
            }, 3000);
          } else {
            addMessage(data.message, 'info');
          }
        });
        
        // ç›‘å¬é”™è¯¯
        window.electronAPI.onProxyDeployError((data) => {
          addMessage('âŒ ' + data.error, 'error');
          deployBtn.disabled = false;
          deployBtn.innerHTML = 'âŒ éƒ¨ç½²å¤±è´¥';
          setTimeout(() => {
            deployBtn.innerHTML = 'ğŸš€ ä¸€é”®éƒ¨ç½² Claude Code Proxy';
          }, 3000);
        });
        
        // è·å–å½“å‰é…ç½®
        const config = {
          OPENAI_API_KEY: currentConfig?.openaiApiKey || currentConfig?.apiKey || 'sk-xKnZ1EtU7YNW14fvMw1NNpxUnHm3KyLG11bkebclSMmNfiDD',
          OPENAI_BASE_URL: currentConfig?.openaiBaseUrl || currentConfig?.apiUrl || 'https://ttkk.inping.com/v1',
          BIG_MODEL: currentConfig?.bigModel || 'claude-opus-4-1-20250805',
          SMALL_MODEL: currentConfig?.smallModel || 'grok-4',
          MAX_TOKENS_LIMIT: currentConfig?.maxTokens || 32000
        };
        
        // å¼€å§‹éƒ¨ç½²
        const result = await window.electronAPI.deployClaudeProxy(config);
        
        if (!result.success) {
          addMessage('âŒ éƒ¨ç½²å¤±è´¥: ' + result.error, 'error');
          deployBtn.disabled = false;
          deployBtn.innerHTML = 'âŒ éƒ¨ç½²å¤±è´¥';
          setTimeout(() => {
            deployBtn.innerHTML = 'ğŸš€ ä¸€é”®éƒ¨ç½² Claude Code Proxy';
          }, 3000);
        }
      } catch (error) {
        console.error('éƒ¨ç½²å¤±è´¥:', error);
        messagesDiv.innerHTML = `<div style="color: #ff6b6b;">âŒ éƒ¨ç½²å¤±è´¥: ${error.message}</div>`;
        deployBtn.disabled = false;
        deployBtn.innerHTML = 'âŒ éƒ¨ç½²å¤±è´¥';
        setTimeout(() => {
          deployBtn.innerHTML = 'ğŸš€ ä¸€é”®éƒ¨ç½² Claude Code Proxy';
        }, 3000);
      }
    }
    
    async function restoreDefaultConfig() {
      const confirm = await window.electronAPI.showConfirm(
        'è¿˜åŸé»˜è®¤é…ç½®',
        'ç¡®å®šè¦è¿˜åŸä¸º Claude Code å®˜æ–¹é»˜è®¤é…ç½®å—ï¼Ÿ\n\nè¿™å°†è¦†ç›–å½“å‰ç¼–è¾‘çš„å†…å®¹ã€‚'
      );
      
      if (!confirm) return;
      
      // è®¾ç½®é»˜è®¤é…ç½®
      const defaultConfig = {
        name: 'Claude Code å®˜æ–¹é…ç½®',
        apiUrl: 'https://api.anthropic.com',
        apiKey: '',  // ç”¨æˆ·éœ€è¦è‡ªå·±å¡«å†™
        model: 'claude-3-5-sonnet-20241022',
        maxTokens: 4096,
        temperature: 0,
        proxy: '',
        useInternalProxy: false, // æ–°å¢
        openaiBaseUrl: '', // æ–°å¢
        openaiApiKey: '', // æ–°å¢
        smallModel: 'gpt-4o-mini', // æ–°å¢
        middleModel: 'gpt-4o', // æ–°å¢
        bigModel: 'gpt-4o' // æ–°å¢
      };
      
      // å¦‚æœå½“å‰æœ‰é…ç½®ï¼Œä¿ç•™ ID
      if (currentConfig && currentConfig.id) {
        defaultConfig.id = currentConfig.id;
      }
      
      // æ›´æ–°è¡¨å•
      document.getElementById('config-name').value = defaultConfig.name;
      document.getElementById('config-apikey').value = defaultConfig.apiKey;
      document.getElementById('config-apiurl').value = defaultConfig.apiUrl;
      document.getElementById('config-model').value = defaultConfig.model;
      document.getElementById('config-proxy').value = defaultConfig.proxy;
      document.getElementById('toggle-internal-proxy').checked = defaultConfig.useInternalProxy;
      document.getElementById('config-openai-base-url').value = defaultConfig.openaiBaseUrl;
      document.getElementById('config-openai-api-key').value = defaultConfig.openaiApiKey;
      document.getElementById('config-small-model').value = defaultConfig.smallModel;
      document.getElementById('config-middle-model').value = defaultConfig.middleModel;
      document.getElementById('config-big-model').value = defaultConfig.bigModel;

      // æ›´æ–°å½“å‰é…ç½®
      Object.assign(currentConfig || {}, defaultConfig);
      
      // æ˜¾ç¤ºæç¤º
      window.electronAPI.showInfo('å·²è¿˜åŸ', 'å·²è¿˜åŸä¸º Claude Code å®˜æ–¹é»˜è®¤é…ç½®ï¼Œè¯·å¡«å†™æ‚¨çš„ API Key');
    }
    
    // åœ¨ç³»ç»Ÿç»ˆç«¯ä¸­æ‰“å¼€
    async function openInSystemTerminal() {
      if (!currentConfig) {
        window.electronAPI.showError('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé…ç½®ï¼');
        showPanel('config');
        return;
      }
      
      if (!currentConfig.apiKey) {
        window.electronAPI.showError('é”™è¯¯', 'è¯·å…ˆé…ç½® API Keyï¼');
        showPanel('config');
        return;
      }
      
      try {
        await window.electronAPI.openSystemTerminal(currentConfig);
        addToTerminal('[ç³»ç»Ÿ] æ­£åœ¨æ‰“å¼€ç³»ç»Ÿç»ˆç«¯...', 'system');
      } catch (error) {
        console.error('æ‰“å¼€ç³»ç»Ÿç»ˆç«¯å¤±è´¥:', error);
        addToTerminal('[é”™è¯¯] æ‰“å¼€ç³»ç»Ÿç»ˆç«¯å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // ç»ˆç«¯åŠŸèƒ½ - å®Œç¾ä½“éªŒ
    let commandHistory = [];
    let historyIndex = -1;
    let currentInput = '';
 
    function getOrCreateTerminalOutput() {
      let output = document.getElementById('terminal-output');
      if (output) return output;
      const container = document.getElementById('terminal-container');
      if (!container) return null;
      let body = document.getElementById('terminal-body');
      if (!body) {
        body = document.createElement('div');
        body.id = 'terminal-body';
        body.className = 'terminal-body';
        container.appendChild(body);
      }
      output = document.createElement('div');
      output.id = 'terminal-output';
      output.className = 'terminal-output';
      body.appendChild(output);
      return output;
    }

    function toggleClaude() {
      if (claudeRunning) {
        stopClaude();
      } else {
        startClaude();
      }
    }
    
    async function startClaude() {
      if (!currentConfig) {
        window.electronAPI.showError('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé…ç½®ï¼');
        showPanel('config');
        return;
      }
      
      try {
        // éšè—æ¬¢è¿ç•Œé¢
        const welcome = document.getElementById('terminal-welcome');
        if (welcome) welcome.style.display = 'none';
        
        // æ·»åŠ å¯åŠ¨æ¶ˆæ¯
        addToTerminal('ç³»ç»Ÿæ­£åœ¨å¯åŠ¨ Claude CLI...', 'system', 'ğŸ”„');
        
        // è°ƒç”¨åç«¯å¯åŠ¨ Claude
        const result = await window.electronAPI.startClaude(currentConfig);
        
        if (result.success) {
          claudeRunning = true;
          
          // æ›´æ–°UIçŠ¶æ€
          const startBtn = document.getElementById('claude-start-btn');
          document.getElementById('claude-btn-icon').textContent = 'â¸';
          document.getElementById('claude-btn-text').textContent = 'åœæ­¢';
          
          document.getElementById('terminal-status-text').textContent = 'å·²è¿æ¥';
          document.getElementById('terminal-status-dot').classList.add('active');
          document.getElementById('terminal-input').disabled = false;
          document.getElementById('terminal-send-btn').disabled = false;
          document.getElementById('status-dot').classList.add('active');
          document.getElementById('status-text').textContent = 'Claude è¿è¡Œä¸­';
          
          // èšç„¦è¾“å…¥æ¡†
          document.getElementById('terminal-input').focus();
        } else {
          addToTerminal('å¯åŠ¨å¤±è´¥: ' + result.error, 'error', 'âŒ');
        }
      } catch (error) {
        console.error('å¯åŠ¨ Claude å¤±è´¥:', error);
        addToTerminal('å¯åŠ¨å¤±è´¥: ' + error.message, 'error', 'âŒ');
      }
    }
    
    function stopClaude() {
      claudeRunning = false;
      
      // æ›´æ–°UIçŠ¶æ€
      document.getElementById('claude-btn-icon').textContent = 'â–¶';
      document.getElementById('claude-btn-text').textContent = 'å¯åŠ¨ Claude';
      
      document.getElementById('terminal-status-text').textContent = 'æœªè¿æ¥';
      document.getElementById('terminal-status-dot').classList.remove('active');
      document.getElementById('terminal-input').disabled = true;
      document.getElementById('terminal-send-btn').disabled = true;
      document.getElementById('status-dot').classList.remove('active');
      document.getElementById('status-text').textContent = 'å°±ç»ª';
      
      addToTerminal('è¿æ¥å·²æ–­å¼€', 'system', 'ğŸ”Œ');
    }
    
    function sendMessage() {
      const input = document.getElementById('terminal-input');
      const text = input.value.trim();
      
      if (!text || !claudeRunning) return;
      
      // æ·»åŠ åˆ°å†å²è®°å½•
      commandHistory.push(text);
      historyIndex = commandHistory.length;
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      input.value = '';
      
      // å‘é€åˆ° Claude è¿›ç¨‹
      window.electronAPI.sendClaudeInput(text);
    }
    
    function showLoadingMessage() {
      const id = 'loading-' + Date.now();
      const output = getOrCreateTerminalOutput();
      
      const loadingDiv = document.createElement('div');
      loadingDiv.id = id;
      loadingDiv.className = 'terminal-line claude';
      loadingDiv.innerHTML = `
        <span class="terminal-line-icon">ğŸ¤–</span>
        <span class="terminal-line-content">
          <span class="typing-indicator">
            <span>â—</span><span>â—</span><span>â—</span>
          </span>
        </span>
      `;
      
      if (output) output.appendChild(loadingDiv);
      scrollToBottom();
      
      return id;
    }
    
    function removeLoadingMessage(id) {
      const element = document.getElementById(id);
      if (element) element.remove();
    }
    
    function addToTerminal(text, type = 'normal', icon = '') {
      const output = getOrCreateTerminalOutput();
      
      // å·²ç§»é™¤ç»ˆç«¯è¾“å‡ºç»†åˆ†é€»è¾‘
      
      const line = document.createElement('div');
      line.className = `terminal-line ${type}`;
      
      const iconSpan = document.createElement('span');
      iconSpan.className = 'terminal-line-icon';
      iconSpan.textContent = icon;
      
      const contentSpan = document.createElement('span');
      contentSpan.className = 'terminal-line-content';
      contentSpan.textContent = text;
      
      line.appendChild(iconSpan);
      line.appendChild(contentSpan);
      
      if (output) output.appendChild(line);
      scrollToBottom();
    }
    
    function clearTerminal() {
      // å·²ç§»é™¤ç»ˆç«¯æ¸…ç©º
    }
    
    function scrollToBottom() {
      const body = document.getElementById('terminal-body');
      if (body) body.scrollTop = body.scrollHeight;
    }
    
    // å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && window.electronAPI.minimize) {
        window.electronAPI.minimize();
      }
      
      // Ctrl/Cmd + 1/2/3 åˆ‡æ¢é¢æ¿
      if ((e.ctrlKey || e.metaKey)) {
        switch(e.key) {
          case '1':
            document.querySelector('.nav-item:nth-child(1)').click();
            break;
          case '2':
            document.querySelector('.nav-item:nth-child(2)').click();
            break;
          case '3':
            document.querySelector('.nav-item:nth-child(3)').click();
            break;
        }
      }
    });
    
    // å¯åŠ¨è¯·æ±‚/å“åº”é¢„è§ˆæ›´æ–°
    function startRequestPreviewUpdates(proxyUrl) {
      const container = document.getElementById('request-preview-container');
      const preview = document.getElementById('request-preview');
      if (!container || !preview) return;
      
      const updatePreview = async () => {
        try {
          const response = await fetch(`${proxyUrl}/health`);
          const health = await response.json();
          if (health.lastRequestPreview) {
            container.style.display = 'block';
            preview.textContent = JSON.stringify(health.lastRequestPreview, null, 2);
          } else {
            container.style.display = 'none';
          }
        } catch (e) {
          // Silently ignore errors
        }
      };
      
      // ç«‹å³æ›´æ–°ä¸€æ¬¡ï¼Œç„¶åæ¯5ç§’æ›´æ–°
      updatePreview();
      setInterval(updatePreview, 5000);
    }
    
    // ========== æ¬¢è¿å¼•å¯¼åŠŸèƒ½ ==========
    function showWelcomeGuide() {
      // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡å¯åŠ¨
      const hasShownWelcome = localStorage.getItem('hasShownWelcome');
      if (hasShownWelcome) return;
      
      const welcomeHtml = `
        <div class="welcome-overlay" id="welcome-overlay">
          <div class="welcome-container">
            <div class="welcome-header">
              <div class="welcome-title">ğŸ‰ æ¬¢è¿ä½¿ç”¨ Miaoda</div>
              <div class="welcome-subtitle">è®©æˆ‘ä»¬å¿«é€Ÿè®¾ç½®æ‚¨çš„ Claude Code ç¯å¢ƒ</div>
            </div>
            
            <div class="quick-setup-options">
              <div class="setup-option recommended" onclick="quickSetupDefault()">
                <div class="setup-option-title">
                  <span class="setup-option-icon">ğŸš€</span>
                  <span>ä¸€é”®å¿«é€Ÿé…ç½®</span>
                </div>
                <div class="setup-option-desc">
                  è‡ªåŠ¨å®‰è£…å¹¶é…ç½® Claude Code Proxyï¼Œä½¿ç”¨æ¨èçš„ API è®¾ç½®ï¼Œç«‹å³å¼€å§‹ä½¿ç”¨
                </div>
              </div>
              
              <div class="setup-option" onclick="quickSetupCustom()">
                <div class="setup-option-title">
                  <span class="setup-option-icon">âš™ï¸</span>
                  <span>è‡ªå®šä¹‰é…ç½®</span>
                </div>
                <div class="setup-option-desc">
                  æ‰‹åŠ¨é…ç½® API Keyã€æ¨¡å‹é€‰æ‹©ç­‰å‚æ•°ï¼Œé€‚åˆæœ‰ç‰¹å®šéœ€æ±‚çš„ç”¨æˆ·
                </div>
              </div>
              
              <div class="setup-option" onclick="quickSetupOfficial()">
                <div class="setup-option-title">
                  <span class="setup-option-icon">ğŸ”—</span>
                  <span>ä½¿ç”¨å®˜æ–¹ API</span>
                </div>
                <div class="setup-option-desc">
                  ç›´æ¥ä½¿ç”¨ Anthropic å®˜æ–¹ APIï¼Œéœ€è¦æ‚¨è‡ªå·±çš„ API Key
                </div>
              </div>
            </div>
            
            <div class="skip-button">
              <button onclick="skipWelcome()">ç¨åè®¾ç½®</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', welcomeHtml);
    }
    
    function quickSetupDefault() {
      localStorage.setItem('hasShownWelcome', 'true');
      document.getElementById('welcome-overlay').remove();
      // ç›´æ¥è°ƒç”¨ä¸€é”®éƒ¨ç½²
      deployClaudeProxy();
    }
    
    function quickSetupCustom() {
      localStorage.setItem('hasShownWelcome', 'true');
      document.getElementById('welcome-overlay').remove();
      // è·³è½¬åˆ°é…ç½®é¡µé¢ - ä¼ é€’æ­£ç¡®çš„å‚æ•°
      const configNavItem = document.querySelector('.nav-item:nth-child(2)');
      if (configNavItem) {
        configNavItem.click();
      }
    }
    
    function quickSetupOfficial() {
      localStorage.setItem('hasShownWelcome', 'true');
      document.getElementById('welcome-overlay').remove();
      // æ¢å¤å®˜æ–¹é…ç½®
      restoreDefaultConfig();
    }
    
    function skipWelcome() {
      localStorage.setItem('hasShownWelcome', 'true');
      document.getElementById('welcome-overlay').remove();
    }
    
    // ========== ä»£ç†çŠ¶æ€ç®¡ç† ==========
    let proxyStatusInterval = null;
    
    async function updateProxyStatus() {
      try {
        const status = await window.electronAPI.getProxyStatus();
        const card = document.getElementById('proxy-status-card');
        const indicator = card.querySelector('.status-indicator');
        const stateEl = document.getElementById('status-state');
        const modelEl = document.getElementById('status-model');
        const portEl = document.getElementById('status-port');
        
        if (status && status.isRunning) {
          card.style.display = 'block';
          indicator.classList.remove('inactive');
          stateEl.textContent = 'è¿è¡Œä¸­';
          stateEl.style.color = '#4ade80';
          portEl.textContent = status.port || '8082';
          
          // è·å–å½“å‰é…ç½®çš„æ¨¡å‹
          const currentConfig = await window.electronAPI.getCurrentConfig();
          if (currentConfig) {
            modelEl.textContent = currentConfig.bigModel || currentConfig.model || 'æœªé…ç½®';
          }
        } else {
          card.style.display = 'block';
          indicator.classList.add('inactive');
          stateEl.textContent = 'æœªå¯åŠ¨';
          stateEl.style.color = '#ef4444';
        }
      } catch (error) {
        console.error('æ›´æ–°ä»£ç†çŠ¶æ€å¤±è´¥:', error);
      }
    }
    
    // å¿«é€Ÿæ“ä½œå‡½æ•°
    async function quickRestart() {
      try {
        const currentConfig = await window.electronAPI.getCurrentConfig();
        if (currentConfig) {
          await window.electronAPI.stopAllProxyServices();
          await new Promise(resolve => setTimeout(resolve, 1000));
          await window.electronAPI.deployClaudeProxy(currentConfig);
          updateProxyStatus();
        }
      } catch (error) {
        console.error('é‡å¯å¤±è´¥:', error);
        window.electronAPI.showError('é‡å¯å¤±è´¥', error.message);
      }
    }
    
    async function quickStop() {
      try {
        await window.electronAPI.stopAllProxyServices();
        updateProxyStatus();
      } catch (error) {
        console.error('åœæ­¢å¤±è´¥:', error);
        window.electronAPI.showError('åœæ­¢å¤±è´¥', error.message);
      }
    }
    
    async function quickSwitchModel(model) {
      if (!model) return;
      
      if (model === 'custom') {
        // è·³è½¬åˆ°é…ç½®é¡µé¢
        const configNavItem = document.querySelector('.nav-item:nth-child(2)');
        if (configNavItem) {
          configNavItem.click();
        }
        return;
      }
      
      try {
        const currentConfig = await window.electronAPI.getCurrentConfig();
        if (currentConfig) {
          currentConfig.bigModel = model;
          currentConfig.model = model;
          await window.electronAPI.saveConfig(currentConfig);
          
          // å¦‚æœä»£ç†æ­£åœ¨è¿è¡Œï¼Œé‡å¯ä»¥åº”ç”¨æ–°æ¨¡å‹
          const status = await window.electronAPI.getProxyStatus();
          if (status && status.isRunning) {
            await quickRestart();
          }
          
          updateProxyStatus();
        }
      } catch (error) {
        console.error('åˆ‡æ¢æ¨¡å‹å¤±è´¥:', error);
        window.electronAPI.showError('åˆ‡æ¢æ¨¡å‹å¤±è´¥', error.message);
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆå
    window.addEventListener('DOMContentLoaded', () => {
      // æ˜¾ç¤ºæ¬¢è¿å¼•å¯¼
      setTimeout(() => {
        showWelcomeGuide();
      }, 500);
      
      // å¯åŠ¨çŠ¶æ€æ›´æ–°
      updateProxyStatus();
      proxyStatusInterval = setInterval(updateProxyStatus, 3000);
      
      // ç›‘å¬æ¨¡å¼åˆ‡æ¢
      document.querySelectorAll('input[name="config-mode"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const openaiSection = document.getElementById('openai-section');
          if (e.target.id === 'mode-openai') {
            openaiSection.style.display = 'block';
          } else {
            openaiSection.style.display = 'none';
          }
        });
      });
    });
    
    // åˆ‡æ¢API Keyå¯è§æ€§
    function toggleApiKeyVisibility() {
      const input = document.getElementById('config-apikey');
      const icon = document.getElementById('api-key-toggle-icon');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'ğŸ™ˆ';
      } else {
        input.type = 'password';
        icon.textContent = 'ğŸ‘';
      }
    }
    
    // æ›´æ–°é…ç½®çŠ¶æ€æ ‡ç­¾
    function updateConfigStatusBadge(status) {
      const badge = document.getElementById('config-status-badge');
      if (!badge) return;
      
      switch(status) {
        case 'saved':
          badge.textContent = 'å·²ä¿å­˜';
          badge.style.color = '#4ade80';
          break;
        case 'unsaved':
          badge.textContent = 'æœªä¿å­˜';
          badge.style.color = '#fbbf24';
          break;
        case 'running':
          badge.textContent = 'è¿è¡Œä¸­';
          badge.style.color = '#60a5fa';
          break;
        default:
          badge.textContent = 'æœªçŸ¥';
          badge.style.color = '#9ca3af';
      }
    }
    
    // ç›‘å¬é…ç½®è¡¨å•å˜åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('config-form');
      if (form) {
        form.addEventListener('input', () => {
          updateConfigStatusBadge('unsaved');
        });
      }
    });
    
    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', () => {
      if (proxyStatusInterval) {
        clearInterval(proxyStatusInterval);
      }
    });
  </script>
</body>
</html>