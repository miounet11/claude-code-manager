<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Miaoda - Claude Code Manager</title>
  <link rel="stylesheet" href="styles/app.css">
  <style>
    /* åœ¨ app.css åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    
    .sidebar {
      width: 200px;
      background: #252525;
      border-right: 1px solid #3e3e3e;
      display: flex;
      flex-direction: column;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: none;
      overflow-y: auto;
      padding: 30px;
    }
    
    .panel.active {
      display: block;
    }
    
    button {
      background: #0dbc79;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    
    button:hover {
      background: #0ba568;
    }
    
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- ä¾§è¾¹æ  -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo">Miaoda</div>
    </div>
    <nav class="nav-menu">
      <div class="nav-item active" onclick="showPanel('environment')">
        <span>ğŸŒ</span>
        <span>ç¯å¢ƒæ£€æµ‹</span>
      </div>
      <div class="nav-item" onclick="showPanel('config')">
        <span>âš™ï¸</span>
        <span>é…ç½®ç®¡ç†</span>
      </div>
      <div class="nav-item" onclick="showPanel('terminal')">
        <span>ğŸ’»</span>
        <span>ç»ˆç«¯</span>
      </div>
    </nav>
  </div>
  
  <!-- ä¸»å†…å®¹ -->
  <div class="main-content">
    <div class="header">
      <h2 id="panel-title">ç¯å¢ƒæ£€æµ‹</h2>
      <div id="header-actions">
        <button onclick="refreshEnvironment()">åˆ·æ–°</button>
      </div>
    </div>
    
    <div class="content">
      <!-- ç¯å¢ƒæ£€æµ‹é¢æ¿ -->
      <div id="environment-panel" class="panel active">
        <div class="env-card">
          <h3>ç³»ç»Ÿä¾èµ–</h3>
          <div id="env-list" style="margin-top: 20px;">
            <div class="env-item">
              <span>Node.js</span>
              <span id="nodejs-status">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="env-item">
              <span>Git</span>
              <span id="git-status">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="env-item">
              <span>Claude CLI</span>
              <span id="claude-status">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="env-item">
              <span>UV</span>
              <span id="uv-status">æ£€æµ‹ä¸­...</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- é…ç½®ç®¡ç†é¢æ¿ -->
      <div id="config-panel" class="panel">
        <div class="config-container">
          <div class="config-list">
            <h3>é…ç½®åˆ—è¡¨</h3>
            <button onclick="createNewConfig()">æ–°å»ºé…ç½®</button>
            <div id="config-list-items"></div>
          </div>
          
          <div class="config-editor">
            <h3>ç¼–è¾‘é…ç½®</h3>
            <form id="config-form">
              <input type="hidden" id="config-id">
              <div>
                <label>é…ç½®åç§°</label>
                <input type="text" id="config-name" placeholder="æˆ‘çš„é…ç½®">
              </div>
              <div>
                <label>API Key</label>
                <input type="password" id="config-apikey" placeholder="sk-...">
              </div>
              <button type="button" onclick="saveConfig()">ä¿å­˜</button>
              <button type="button" onclick="deleteConfig()">åˆ é™¤</button>
            </form>
          </div>
        </div>
      </div>
      
      <!-- ç»ˆç«¯é¢æ¿ -->
      <div id="terminal-panel" class="panel">
        <div class="terminal-header">
          <h3>Claude ç»ˆç«¯</h3>
          <button id="claude-toggle" onclick="toggleClaude()">å¯åŠ¨ Claude</button>
        </div>
        <div id="terminal-output" style="background: #000; padding: 20px; margin-top: 20px; height: 400px; overflow-y: auto; font-family: monospace;">
          <div>æ¬¢è¿ä½¿ç”¨ Miaoda Claude ç»ˆç«¯</div>
        </div>
        <div style="margin-top: 10px;">
          <input type="text" id="terminal-input" placeholder="è¾“å…¥å‘½ä»¤..." style="width: 100%; padding: 10px;" disabled>
        </div>
      </div>
    </div>
    
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
      <span>ç‰ˆæœ¬: <span id="app-version">2.1.0</span></span>
      <span id="status-text">å°±ç»ª</span>
    </div>
  </div>
  
  <script>
    // å…¨å±€çŠ¶æ€
    let currentPanel = 'environment';
    let currentConfig = null;
    let claudeRunning = false;
    let configs = [];
    
    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      initializeApp();
    });
    
    async function initializeApp() {
      // è·å–ç‰ˆæœ¬
      try {
        const version = await window.electronAPI.getVersion();
        document.getElementById('app-version').textContent = version;
      } catch (error) {
        console.error('è·å–ç‰ˆæœ¬å¤±è´¥:', error);
      }
      
      // è®¾ç½®äº‹ä»¶ç›‘å¬
      setupEventListeners();
      
      // åŠ è½½åˆå§‹æ•°æ®
      refreshEnvironment();
      loadConfigs();
    }
    
    function setupEventListeners() {
      // ç»ˆç«¯è¾“å…¥
      const terminalInput = document.getElementById('terminal-input');
      terminalInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && claudeRunning) {
          const command = e.target.value.trim();
          if (command) {
            window.electronAPI.sendClaudeInput(command);
            e.target.value = '';
          }
        }
      });
      
      // Claude è¾“å‡ºç›‘å¬
      window.electronAPI.onClaudeOutput((data) => {
        addToTerminal(data.text, data.type);
      });
      
      // Claude çŠ¶æ€ç›‘å¬
      window.electronAPI.onClaudeStarted(() => {
        claudeRunning = true;
        document.getElementById('claude-toggle').textContent = 'åœæ­¢ Claude';
        document.getElementById('terminal-input').disabled = false;
        document.getElementById('status-text').textContent = 'Claude è¿è¡Œä¸­';
      });
      
      window.electronAPI.onClaudeStopped(() => {
        claudeRunning = false;
        document.getElementById('claude-toggle').textContent = 'å¯åŠ¨ Claude';
        document.getElementById('terminal-input').disabled = true;
        document.getElementById('status-text').textContent = 'å°±ç»ª';
      });
    }
    
    // é¢æ¿åˆ‡æ¢
    function showPanel(panelName) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      
      document.querySelectorAll('.panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.getElementById(`${panelName}-panel`).classList.add('active');
      
      const titles = {
        environment: 'ç¯å¢ƒæ£€æµ‹',
        config: 'é…ç½®ç®¡ç†',
        terminal: 'ç»ˆç«¯'
      };
      document.getElementById('panel-title').textContent = titles[panelName];
      
      const headerActions = document.getElementById('header-actions');
      if (panelName === 'environment') {
        headerActions.innerHTML = '<button onclick="refreshEnvironment()">åˆ·æ–°</button>';
      } else {
        headerActions.innerHTML = '';
      }
      
      currentPanel = panelName;
    }
    
    // ç¯å¢ƒæ£€æµ‹
    async function refreshEnvironment() {
      try {
        const envData = await window.electronAPI.checkEnvironment();
        
        Object.entries(envData).forEach(([key, data]) => {
          const statusEl = document.getElementById(`${key}-status`);
          if (statusEl) {
            if (data.installed) {
              statusEl.textContent = `âœ… ${data.version}`;
              statusEl.style.color = '#0dbc79';
            } else {
              statusEl.textContent = 'âŒ æœªå®‰è£…';
              statusEl.style.color = '#cd3131';
            }
          }
        });
      } catch (error) {
        console.error('ç¯å¢ƒæ£€æµ‹å¤±è´¥:', error);
      }
    }
    
    // é…ç½®ç®¡ç†
    async function loadConfigs() {
      try {
        configs = await window.electronAPI.getAllConfigs();
        renderConfigList();
        if (configs.length > 0) {
          selectConfig(configs[0]);
        }
      } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
      }
    }
    
    function renderConfigList() {
      const listEl = document.getElementById('config-list-items');
      listEl.innerHTML = configs.map(config => `
        <div onclick="selectConfig('${config.id}')" style="padding: 10px; cursor: pointer; ${currentConfig?.id === config.id ? 'background: #3e3e3e;' : ''}">
          ${config.name}
        </div>
      `).join('');
    }
    
    function selectConfig(configOrId) {
      const config = typeof configOrId === 'string' 
        ? configs.find(c => c.id === configOrId)
        : configOrId;
        
      if (!config) return;
      
      currentConfig = config;
      document.getElementById('config-id').value = config.id;
      document.getElementById('config-name').value = config.name;
      document.getElementById('config-apikey').value = config.apiKey || '';
      renderConfigList();
    }
    
    function createNewConfig() {
      const newConfig = {
        id: Date.now().toString(),
        name: 'æ–°é…ç½®',
        apiKey: ''
      };
      configs.push(newConfig);
      selectConfig(newConfig);
    }
    
    async function saveConfig() {
      if (!currentConfig) return;
      
      currentConfig.name = document.getElementById('config-name').value;
      currentConfig.apiKey = document.getElementById('config-apikey').value;
      
      try {
        await window.electronAPI.saveConfig(currentConfig);
        await window.electronAPI.setCurrentConfig(currentConfig);
        renderConfigList();
        alert('é…ç½®å·²ä¿å­˜ï¼');
      } catch (error) {
        console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
      }
    }
    
    async function deleteConfig() {
      if (!currentConfig) return;
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ')) return;
      
      try {
        await window.electronAPI.deleteConfig(currentConfig.id);
        configs = configs.filter(c => c.id !== currentConfig.id);
        renderConfigList();
        if (configs.length > 0) {
          selectConfig(configs[0]);
        } else {
          currentConfig = null;
          document.getElementById('config-form').reset();
        }
      } catch (error) {
        console.error('åˆ é™¤é…ç½®å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
      }
    }
    
    // ç»ˆç«¯åŠŸèƒ½
    async function toggleClaude() {
      if (claudeRunning) {
        try {
          await window.electronAPI.stopClaude();
        } catch (error) {
          console.error('åœæ­¢ Claude å¤±è´¥:', error);
        }
      } else {
        if (!currentConfig) {
          alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé…ç½®ï¼');
          showPanel('config');
          return;
        }
        
        try {
          await window.electronAPI.startClaude(currentConfig);
        } catch (error) {
          console.error('å¯åŠ¨ Claude å¤±è´¥:', error);
          alert('å¯åŠ¨å¤±è´¥ï¼š' + error.message);
        }
      }
    }
    
    function addToTerminal(text, type = 'normal') {
      const output = document.getElementById('terminal-output');
      const line = document.createElement('div');
      
      switch(type) {
        case 'system':
          line.style.color = '#e5e510';
          break;
        case 'claude':
          line.style.color = '#0dbc79';
          break;
        case 'user':
          line.style.color = '#d4d4d4';
          break;
        case 'error':
          line.style.color = '#cd3131';
          break;
      }
      
      line.textContent = text;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }
  </script>
</body>
</html>