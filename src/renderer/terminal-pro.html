<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Miaoda Terminal</title>
  <link rel="stylesheet" href="../../node_modules/xterm/css/xterm.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0d1117;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* å¤´éƒ¨ */
    .terminal-header {
      background: linear-gradient(to bottom, #1c2128, #161b22);
      border-bottom: 1px solid #30363d;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .terminal-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #3f4451;
      transition: all 0.3s;
    }
    
    .status-dot.active {
      background: #0dbc79;
      box-shadow: 0 0 8px rgba(13, 188, 121, 0.5);
    }
    
    .terminal-actions {
      display: flex;
      gap: 8px;
    }
    
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 5px;
      cursor: pointer;
      font-family: inherit;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    button:hover {
      background: #2ea043;
    }
    
    button.secondary {
      background: #21262d;
    }
    
    button.secondary:hover {
      background: #30363d;
    }
    
    /* ç»ˆç«¯å®¹å™¨ */
    #terminal-container {
      flex: 1;
      padding: 16px;
      overflow: hidden;
    }
    
    #terminal {
      height: 100%;
      background: #0d1117;
      border-radius: 6px;
      padding: 8px;
    }
    
    /* æœç´¢æ¡† */
    .search-box {
      position: absolute;
      top: 60px;
      right: 20px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 8px;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .search-box input {
      background: #0d1117;
      border: 1px solid #30363d;
      color: #d4d4d4;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      width: 200px;
    }
    
    /* å¿«æ·é”®æç¤º */
    .shortcuts {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 12px;
      font-size: 11px;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    
    .shortcuts:hover {
      opacity: 1;
    }
    
    .shortcut-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      gap: 20px;
    }
    
    .shortcut-key {
      background: #21262d;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="terminal-header">
    <div class="terminal-status">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">æœªè¿æ¥</span>
      <span id="terminal-info" style="color: #666; margin-left: 10px;"></span>
    </div>
    <div class="terminal-actions">
      <button onclick="toggleConnection()" id="connect-btn">
        <span>â–¶</span>
        <span>è¿æ¥</span>
      </button>
      <button class="secondary" onclick="clearTerminal()">
        <span>ğŸ—‘ï¸</span>
        <span>æ¸…ç©º</span>
      </button>
      <button class="secondary" onclick="toggleSearch()">
        <span>ğŸ”</span>
        <span>æœç´¢</span>
      </button>
    </div>
  </div>
  
  <div id="terminal-container">
    <div id="terminal"></div>
  </div>
  
  <div class="search-box" id="search-box">
    <input type="text" id="search-input" placeholder="æœç´¢..." onkeyup="handleSearch(event)">
  </div>
  
  <div class="shortcuts">
    <div class="shortcut-item">
      <span>æ¸…å±</span>
      <span class="shortcut-key">Ctrl+K</span>
    </div>
    <div class="shortcut-item">
      <span>ä¸­æ–­</span>
      <span class="shortcut-key">Ctrl+C</span>
    </div>
    <div class="shortcut-item">
      <span>æœç´¢</span>
      <span class="shortcut-key">Ctrl+F</span>
    </div>
  </div>
  
  <script>
    const XtermTerminal = require('./xterm-terminal');
    let terminal = null;
    let isConnected = false;
    
    // åˆå§‹åŒ–ç»ˆç«¯
    function initTerminal() {
      const container = document.getElementById('terminal');
      terminal = new XtermTerminal(container);
      
      // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
      terminal.writeln('\x1b[1;32mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\x1b[0m');
      terminal.writeln('\x1b[1;32mâ•‘                 Miaoda Professional Terminal                   â•‘\x1b[0m');
      terminal.writeln('\x1b[1;32mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\x1b[0m');
      terminal.writeln('');
      terminal.writeln('æ¬¢è¿ä½¿ç”¨ Miaoda ä¸“ä¸šç»ˆç«¯ - åŸºäº xterm.js æ‰“é€ ');
      terminal.writeln('');
      terminal.writeln('â€¢ æ”¯æŒ ANSI è½¬ä¹‰åºåˆ—å’Œé¢œè‰²');
      terminal.writeln('â€¢ å®Œæ•´çš„å¿«æ·é”®æ”¯æŒ');
      terminal.writeln('â€¢ å‘½ä»¤å†å²è®°å½•');
      terminal.writeln('â€¢ é“¾æ¥è¯†åˆ«å’Œç‚¹å‡»');
      terminal.writeln('');
      terminal.write('\x1b[32mâ¯\x1b[0m ');
      
      // æ›´æ–°ç»ˆç«¯ä¿¡æ¯
      updateTerminalInfo();
      
      // è®¾ç½®å‘½ä»¤å¤„ç†
      terminal.onCommand = (command) => {
        if (isConnected) {
          // å‘é€åˆ° Claude
          window.electronAPI.sendClaudeInput(command);
        } else {
          terminal.writeln('\x1b[31mé”™è¯¯: è¯·å…ˆè¿æ¥åˆ° Claude\x1b[0m');
          terminal.write('\x1b[32mâ¯\x1b[0m ');
        }
      };
      
      // è®¾ç½®ä¸­æ–­å¤„ç†
      terminal.onInterrupt = () => {
        if (isConnected) {
          // å¯ä»¥å®ç°ä¸­æ–­åŠŸèƒ½
          terminal.writeln('\x1b[33må·²å‘é€ä¸­æ–­ä¿¡å·\x1b[0m');
        }
        terminal.write('\x1b[32mâ¯\x1b[0m ');
      };
      
      // ç›‘å¬ Claude è¾“å‡º
      window.electronAPI.onClaudeOutput((data) => {
        if (data.type === 'raw') {
          terminal.write(data.text);
        } else if (data.type === 'system') {
          terminal.writeln(`\x1b[33m[ç³»ç»Ÿ] ${data.text}\x1b[0m`);
        } else if (data.type === 'error') {
          terminal.writeln(`\x1b[31m[é”™è¯¯] ${data.text}\x1b[0m`);
        }
      });
      
      // ç›‘å¬å¿«æ·é”®
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault();
          toggleSearch();
        }
      });
    }
    
    // æ›´æ–°ç»ˆç«¯ä¿¡æ¯
    function updateTerminalInfo() {
      if (terminal) {
        const dims = terminal.getDimensions();
        document.getElementById('terminal-info').textContent = `${dims.cols}Ã—${dims.rows}`;
      }
    }
    
    // åˆ‡æ¢è¿æ¥
    async function toggleConnection() {
      if (isConnected) {
        // æ–­å¼€è¿æ¥
        await window.electronAPI.stopClaude();
        isConnected = false;
        document.getElementById('status-dot').classList.remove('active');
        document.getElementById('status-text').textContent = 'æœªè¿æ¥';
        document.getElementById('connect-btn').innerHTML = '<span>â–¶</span><span>è¿æ¥</span>';
      } else {
        // è¿æ¥
        const config = await window.electronAPI.getCurrentConfig();
        if (!config) {
          terminal.writeln('\x1b[31mé”™è¯¯: è¯·å…ˆé…ç½® API Key\x1b[0m');
          return;
        }
        
        terminal.writeln(`\x1b[33mæ­£åœ¨è¿æ¥åˆ° Claude...\x1b[0m`);
        const result = await window.electronAPI.startClaude(config);
        
        if (result.success) {
          isConnected = true;
          document.getElementById('status-dot').classList.add('active');
          document.getElementById('status-text').textContent = 'å·²è¿æ¥';
          document.getElementById('connect-btn').innerHTML = '<span>â¸</span><span>æ–­å¼€</span>';
        } else {
          terminal.writeln(`\x1b[31mè¿æ¥å¤±è´¥: ${result.error}\x1b[0m`);
        }
      }
    }
    
    // æ¸…ç©ºç»ˆç«¯
    function clearTerminal() {
      if (terminal) {
        terminal.clear();
        terminal.write('\x1b[32mâ¯\x1b[0m ');
      }
    }
    
    // åˆ‡æ¢æœç´¢
    function toggleSearch() {
      const searchBox = document.getElementById('search-box');
      if (searchBox.style.display === 'block') {
        searchBox.style.display = 'none';
      } else {
        searchBox.style.display = 'block';
        document.getElementById('search-input').focus();
      }
    }
    
    // å¤„ç†æœç´¢
    function handleSearch(event) {
      if (event.key === 'Enter') {
        const term = event.target.value;
        if (term && terminal) {
          terminal.search(term);
        }
      } else if (event.key === 'Escape') {
        toggleSearch();
      }
    }
    
    // çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
      if (terminal) {
        terminal.fit();
        updateTerminalInfo();
      }
    });
    
    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      initTerminal();
    });
  </script>
</body>
</html>