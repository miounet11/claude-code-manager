# Miaoda 更新功能测试指南

## 测试准备

### 1. 启动模拟服务器

```bash
# 在项目目录下运行
node test/mock-update-server.js
```

服务器会在 `http://localhost:8889` 启动，提供模拟的更新信息。

### 2. 设置环境变量

在新的终端窗口中设置环境变量，让应用使用本地模拟服务器：

```bash
export MIAODA_UPDATE_CHECK_URL=http://localhost:8889/updates.json
export MIAODA_API_BASE_URL=http://localhost:8889
```

### 3. 启动应用

```bash
npm run dev
```

## 测试场景

### 场景 1：自动更新检查

1. **启动应用后等待 10 秒**
   - 应用会自动检查更新
   - 查看模拟服务器的日志，应该看到 `GET /updates.json` 请求

2. **验证**
   - 如果设置的版本高于当前版本（4.1.0），会弹出更新提示
   - 如果版本相同或更低，不会有提示（静默检查）

### 场景 2：手动更新检查

1. **右键点击系统托盘图标**
2. **选择"检查更新"**
3. **验证**
   - 会立即显示更新检查结果
   - 有新版本：显示更新对话框
   - 无新版本：显示"已经是最新版本"

### 场景 3：可选更新

1. **修改模拟服务器的配置**
   ```javascript
   // 在 mock-update-server.js 中
   forceUpdate: false,  // 确保是 false
   version: "4.2.0",    // 高于当前版本
   ```

2. **重启模拟服务器并触发更新检查**

3. **验证对话框**
   - 标题：发现新版本
   - 显示版本信息和更新内容
   - 三个按钮：立即更新、稍后提醒、跳过此版本

4. **测试各个选项**
   - **立即更新**：会在浏览器中打开下载链接
   - **稍后提醒**：关闭对话框，下次检查会再次提示
   - **跳过此版本**：记录跳过的版本，不再提示（除非强制更新）

### 场景 4：强制更新

1. **修改模拟服务器的配置**
   ```javascript
   forceUpdate: true,   // 改为 true
   version: "5.0.0",    // 更高的版本
   ```

2. **重启模拟服务器并触发更新检查**

3. **验证对话框**
   - 标题：需要更新
   - 说明必须更新才能继续使用
   - 两个按钮：立即更新、退出程序

4. **测试选项**
   - **立即更新**：打开下载链接
   - **退出程序**：应用退出

### 场景 5：统计上报

1. **应用运行时的行为**
   - 启动 5 秒后会尝试上报历史数据
   - 查看模拟服务器日志，应该看到 `POST /api/analytics/batch` 请求

2. **退出应用**
   - 退出前会上报当前会话数据
   - 查看服务器日志验证

## 验证升级流程

### 1. 下载验证

当用户点击"立即更新"后：
- ✅ 浏览器会打开并开始下载 DMG 文件
- ✅ 下载链接指向 GitHub Releases（或配置的下载服务器）

### 2. 安装验证

1. **下载完成后**
   - 双击 DMG 文件
   - 将 Miaoda 拖到 Applications 文件夹

2. **替换旧版本**
   - macOS 会提示是否替换现有版本
   - 选择"替换"

### 3. 启动新版本

1. **关闭当前运行的旧版本**
2. **从 Applications 启动新版本**
3. **验证版本号**
   - 在应用中查看版本号是否已更新

## 测试检查清单

- [ ] 自动更新检查（启动后 10 秒）
- [ ] 手动更新检查（托盘菜单）
- [ ] 可选更新对话框显示正确
- [ ] 强制更新对话框显示正确
- [ ] "立即更新"打开正确的下载链接
- [ ] "跳过此版本"功能正常
- [ ] 强制更新时"退出程序"正常退出
- [ ] 统计数据能正常上报
- [ ] 下载的安装包能正常安装
- [ ] 新版本能正常启动

## 常见问题

### Q: 为什么没有弹出更新提示？
A: 检查以下几点：
1. 模拟服务器是否正在运行
2. 环境变量是否正确设置
3. 版本号是否高于当前版本（4.1.0）
4. 查看开发者工具的 Console 是否有错误

### Q: 如何测试不同的场景？
A: 修改 `mock-update-server.js` 中的 `updateInfo` 对象：
- `version`: 改变版本号
- `forceUpdate`: true/false 控制是否强制更新
- `updateMessage`: 修改提示信息
- `downloads`: 修改下载链接

### Q: 如何查看统计数据？
A: 查看模拟服务器的控制台输出，会显示收到的统计数据详情。

### Q: 生产环境如何配置？
A: 生产环境会使用默认的 API 地址：
- 更新检查：`https://api.iclaudecode.cn/updates.json`
- 统计上报：`https://api.iclaudecode.cn/api/analytics/batch`

## 注意事项

1. **测试时使用模拟服务器**，避免影响生产环境
2. **版本号必须高于当前版本**才会提示更新
3. **强制更新会阻止用户继续使用**，谨慎使用
4. **统计数据是匿名的**，不包含任何个人信息