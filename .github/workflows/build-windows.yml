name: Build Windows Only

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v2.0.7)'
        required: true
        default: 'v2.0.7'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ„å»º Windows ç‰ˆæœ¬
      run: npm run dist-win
      
    - name: éªŒè¯æ„å»ºç»“æœ
      run: |
        if (Test-Path "dist") {
          Write-Output "âœ… æ„å»ºæˆåŠŸï¼"
          Get-ChildItem -Path "dist" -Filter "*.exe" | ForEach-Object { Write-Output "- $($_.Name)" }
          Get-ChildItem -Path "dist" -Filter "*win*.zip" | ForEach-Object { Write-Output "- $($_.Name)" }
        } else {
          Write-Error "âŒ æ„å»ºå¤±è´¥ï¼šæœªæ‰¾åˆ° dist ç›®å½•"
          exit 1
        }
      shell: powershell
      
    - name: ä¸Šä¼  Windows æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: windows-builds
        path: |
          dist/*.exe
          dist/*win*.zip
        retention-days: 90
        
    - name: åˆ›å»º Release (ä»…æ ‡ç­¾æ¨é€æ—¶)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Miaoda ${{ github.ref_name }} - Windows ç‰ˆæœ¬
        body: |
          # Miaoda ${{ github.ref_name }} - Windows ç‰ˆæœ¬
          
          ## ğŸ“¦ Windows ä¸‹è½½
          
          - **Miaoda-Setup-${{ github.ref_name }}.exe** - NSIS å®‰è£…åŒ…ï¼ˆæ¨èï¼‰
          - **Miaoda-${{ github.ref_name }}-win.zip** - ä¾¿æºç‰ˆï¼ˆå…å®‰è£…ï¼‰
          
          ## ğŸªŸ Windows ç‰ˆæœ¬ç‰¹æ€§
          
          - æ”¯æŒ x64 å’Œ ia32 æ¶æ„
          - NSIS å®‰è£…ç¨‹åºæä¾›å®Œæ•´å®‰è£…ä½“éªŒ
          - ä¾¿æºç‰ˆå¯ç›´æ¥è§£å‹ä½¿ç”¨
          - è‡ªåŠ¨åˆ›å»ºæ¡Œé¢å’Œå¼€å§‹èœå•å¿«æ·æ–¹å¼
          - å®Œæ•´çš„å¸è½½ç¨‹åºæ”¯æŒ
          
          ## âš ï¸ å®‰è£…è¯´æ˜
          
          - Windows ç”¨æˆ·å¦‚é‡åˆ°å®‰å…¨è­¦å‘Šï¼Œè¯·é€‰æ‹©"æ›´å¤šä¿¡æ¯"åç‚¹å‡»"ä»è¦è¿è¡Œ"
          - å»ºè®®ä¸´æ—¶å…³é—­æ€æ¯’è½¯ä»¶çš„å®æ—¶é˜²æŠ¤å†è¿›è¡Œå®‰è£…
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
          
          ## ğŸ”§ ç³»ç»Ÿè¦æ±‚
          
          - Windows 10/11 (64ä½æ¨è)
          - æœ€ä½ 4GB RAMï¼Œæ¨è 8GB+
          - è‡³å°‘ 1GB å¯ç”¨å­˜å‚¨ç©ºé—´
          - éœ€è¦äº’è”ç½‘è¿æ¥ä»¥ä½¿ç”¨ Claude Code
        files: |
          dist/*.exe
          dist/*win*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æ„å»ºå®Œæˆé€šçŸ¥
      run: |
        Write-Output "âœ… Windows ç‰ˆæœ¬æ„å»ºå®Œæˆï¼"
        Write-Output "ğŸ“¦ æ„å»ºç‰ˆæœ¬: ${{ github.ref_name || 'manual-build' }}"
        if ("${{ github.ref_type }}" -eq "tag") {
          Write-Output "ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
        }
      shell: powershell