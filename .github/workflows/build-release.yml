name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v2.0.5)'
        required: true
        default: 'v2.0.5'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ„å»º macOS ç‰ˆæœ¬
      if: matrix.os == 'macos-latest'
      run: npm run dist-mac
      
    - name: æ„å»º Windows ç‰ˆæœ¬
      if: matrix.os == 'windows-latest'
      run: npm run dist-win
      
    - name: æ„å»º Linux ç‰ˆæœ¬
      if: matrix.os == 'ubuntu-latest'
      run: npm run dist-linux
      
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os }}-builds
        path: |
          dist/*.dmg
          dist/*.zip
          dist/*.exe
          dist/*.AppImage
          dist/*.deb
        retention-days: 90
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: æ•´ç†æ„å»ºäº§ç‰©
      run: |
        mkdir -p release-files
        find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" \) -exec cp {} release-files/ \;
        ls -la release-files/
        
    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        cat > release_notes.md << 'EOF'
        # Miaoda $VERSION - AI ç¼–ç¨‹ç¥å™¨
        
        ## ğŸš€ ä¸»è¦ç‰¹æ€§
        
        - **Claude Code é›†æˆ**: æ·±åº¦é›†æˆ Claude Codeï¼Œæä¾›æµç•…çš„ AI ç¼–ç¨‹ä½“éªŒ
        - **è¿›ç¨‹å®ˆæŠ¤**: æ™ºèƒ½è¿›ç¨‹ç®¡ç†ï¼Œç¡®ä¿ Claude Code ç¨³å®šè¿è¡Œ
        - **ç³»ç»Ÿæ‰˜ç›˜**: ä¾¿æ·çš„ç³»ç»Ÿæ‰˜ç›˜æ§åˆ¶ï¼Œéšæ—¶ç®¡ç†åº”ç”¨çŠ¶æ€
        - **è·¨å¹³å°æ”¯æŒ**: æ”¯æŒ macOSã€Windowsã€Linux å¤šå¹³å°
        
        ## ğŸ“¦ ä¸‹è½½è¯´æ˜
        
        ### Windows ç”¨æˆ·
        - **Miaoda-Setup-{version}.exe**: å®Œæ•´å®‰è£…åŒ…ï¼Œæ¨èä½¿ç”¨
        - **Miaoda-{version}-win.zip**: ä¾¿æºç‰ˆï¼Œæ— éœ€å®‰è£…
        
        ### macOS ç”¨æˆ·
        - **Miaoda-{version}.dmg**: Intel Mac å®‰è£…åŒ…
        - **Miaoda-{version}-arm64.dmg**: Apple Silicon å®‰è£…åŒ…
        - **Miaoda-{version}-mac.zip**: Intel Mac å‹ç¼©åŒ…
        - **Miaoda-{version}-arm64-mac.zip**: Apple Silicon å‹ç¼©åŒ…
        
        ### Linux ç”¨æˆ·
        - **Miaoda-{version}.AppImage**: é€šç”¨ Linux åº”ç”¨
        - **miaoda_{version}_amd64.deb**: Debian/Ubuntu åŒ…
        
        ## âš ï¸ é‡è¦æç¤º
        
        - macOS ç”¨æˆ·é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸åº”ç”¨è¿è¡Œ
        - Windows ç”¨æˆ·å¦‚é‡åˆ°å®‰å…¨è­¦å‘Šï¼Œè¯·é€‰æ‹©"æ›´å¤šä¿¡æ¯"åç‚¹å‡»"ä»è¦è¿è¡Œ"
        - å»ºè®®å…³é—­æ€æ¯’è½¯ä»¶çš„å®æ—¶é˜²æŠ¤å†è¿›è¡Œå®‰è£…
        
        ## ğŸ”§ ç³»ç»Ÿè¦æ±‚
        
        - **æ“ä½œç³»ç»Ÿ**: macOS 10.15+, Windows 10+, Linux (64-bit)
        - **å†…å­˜**: æœ€ä½ 4GB RAMï¼Œæ¨è 8GB+
        - **å­˜å‚¨**: è‡³å°‘ 1GB å¯ç”¨ç©ºé—´
        - **ç½‘ç»œ**: éœ€è¦äº’è”ç½‘è¿æ¥ä»¥ä½¿ç”¨ Claude Code
        
        ## ğŸ“ æŠ€æœ¯æ”¯æŒ
        
        å¦‚é‡é—®é¢˜è¯·è®¿é—®ï¼š
        - [GitHub Issues](https://github.com/miounet11/claude-code-manager/issues)
        - [ä½¿ç”¨æ–‡æ¡£](https://github.com/miounet11/claude-code-manager/blob/main/README.md)
        EOF
        
        # æ›¿æ¢ç‰ˆæœ¬å·å ä½ç¬¦
        sed -i "s/{version}/${VERSION#v}/g" release_notes.md
        
    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: Miaoda ${{ steps.get_version.outputs.version }} - AI ç¼–ç¨‹ç¥å™¨
        body_path: release_notes.md
        files: release-files/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æ„å»ºå®Œæˆé€šçŸ¥
      run: |
        echo "âœ… æ„å»ºå’Œå‘å¸ƒå®Œæˆï¼"
        echo "ğŸ“¦ å‘å¸ƒç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
        echo "ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }}"