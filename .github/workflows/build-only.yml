name: Build Only (CI)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  test-build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: è¿è¡Œä»£ç æ£€æŸ¥
      run: npm run lint
      continue-on-error: true
      
    - name: æµ‹è¯•æž„å»º macOS ç‰ˆæœ¬
      if: matrix.os == 'macos-latest'
      run: npm run dist-mac
      
    - name: æµ‹è¯•æž„å»º Windows ç‰ˆæœ¬
      if: matrix.os == 'windows-latest'
      run: npm run dist-win
      
    - name: æµ‹è¯•æž„å»º Linux ç‰ˆæœ¬
      if: matrix.os == 'ubuntu-latest'
      run: npm run dist-linux
      
    - name: éªŒè¯æž„å»ºäº§ç‰©
      run: |
        if [ -d "dist" ]; then
          echo "âœ… æž„å»ºæˆåŠŸï¼Œäº§ç‰©å·²ç”Ÿæˆ"
          ls -la dist/
        else
          echo "âŒ æž„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ° dist ç›®å½•"
          exit 1
        fi
      shell: bash
      
    - name: ä¸Šä¼ æµ‹è¯•æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: test-build-${{ matrix.os }}
        path: |
          dist/*.dmg
          dist/*.zip
          dist/*.exe
          dist/*.AppImage
          dist/*.deb
        retention-days: 7  # æµ‹è¯•æž„å»ºåªä¿ç•™7å¤©
        
  build-summary:
    needs: test-build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: æž„å»ºç»“æžœæ±‡æ€»
      run: |
        echo "## ðŸ”¨ æž„å»ºæµ‹è¯•ç»“æžœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.test-build.result }}" == "success" ]; then
          echo "âœ… **æ‰€æœ‰å¹³å°æž„å»ºæµ‹è¯•é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… macOS æž„å»ºæµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Windows æž„å»ºæµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY  
          echo "- âœ… Linux æž„å»ºæµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **æž„å»ºæµ‹è¯•å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—ä»¥èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "å¦‚æžœæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæ‚¨å¯ä»¥ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "1. åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾æ¥è§¦å‘æ­£å¼å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
        echo "2. ä½¿ç”¨ \`git tag v<ç‰ˆæœ¬å·> && git push origin v<ç‰ˆæœ¬å·>\`" >> $GITHUB_STEP_SUMMARY
        echo "3. æˆ–åœ¨ GitHub ç½‘é¡µä¸Šåˆ›å»ºæ–°çš„ Release" >> $GITHUB_STEP_SUMMARY