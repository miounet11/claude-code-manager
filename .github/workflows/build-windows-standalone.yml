name: Build Windows Standalone Version

on:
  push:
    branches:
      - feature/windows-support
    paths:
      - 'src-windows/**'
      - 'package-windows.json'
      - 'electron-builder-windows.json'
      - '.github/workflows/build-windows-standalone.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      build_32bit:
        description: 'Build 32-bit version'
        type: boolean
        default: true
      build_msi:
        description: 'Build MSI installer'
        type: boolean
        default: true

jobs:
  build-windows:
    runs-on: windows-latest
    
    strategy:
      matrix:
        include:
          - arch: x64
            build: true
          - arch: ia32
            build: ${{ github.event.inputs.build_32bit != 'false' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Cache Electron
      uses: actions/cache@v3
      with:
        path: |
          ~/.electron
          ~/.cache/electron
          ~/.cache/electron-builder
        key: ${{ runner.os }}-electron-${{ matrix.arch }}-${{ hashFiles('package-windows.json') }}
    
    - name: Install dependencies
      run: |
        npm ci
        npm install -g electron-builder
    
    - name: Prepare Windows build
      run: |
        # å¤‡ä»½åŽŸå§‹ package.json
        Copy-Item package.json package.original.json -Force -ErrorAction SilentlyContinue
        
        # ä½¿ç”¨ Windows ç‰ˆæœ¬çš„ package.json
        Copy-Item package-windows.json package.json -Force
        
        # æ›´æ–°ç‰ˆæœ¬å·
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $package = Get-Content package.json | ConvertFrom-Json
          $package.version = "${{ github.event.inputs.version }}"
          $package | ConvertTo-Json -Depth 10 | Set-Content package.json
        }
        
        # ç¡®ä¿ Windows å›¾æ ‡å­˜åœ¨
        if (!(Test-Path "assets/icon.ico")) {
          Write-Warning "Windows icon not found, build may fail"
        }
      shell: powershell
    
    - name: Build Windows ${{ matrix.arch }}
      if: matrix.build
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CSC_IDENTITY_AUTO_DISCOVERY: false
      run: |
        # è®¾ç½®æž¶æž„
        $env:npm_config_arch="${{ matrix.arch }}"
        $env:npm_config_target_arch="${{ matrix.arch }}"
        
        # æž„å»ºå‚æ•°
        $targets = @("nsis", "zip")
        if ("${{ github.event.inputs.build_msi }}" -ne "false" -and "${{ matrix.arch }}" -eq "x64") {
          $targets += "msi"
        }
        
        # æž„å»º
        npx electron-builder --config electron-builder-windows.json --${{ matrix.arch }} --win $($targets -join ",") --publish=never
        
        # åˆ—å‡ºæž„å»ºäº§ç‰©
        Write-Output "Build artifacts:"
        Get-ChildItem -Path "dist-windows" -Include "*.exe","*.msi","*.zip" -Recurse | ForEach-Object {
          Write-Output "- $($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)"
        }
      shell: powershell
    
    - name: Test installer
      if: matrix.build && matrix.arch == 'x64'
      run: |
        # ç®€å•éªŒè¯å®‰è£…åŒ…
        $installer = Get-ChildItem -Path "dist-windows" -Filter "*-x64.exe" | Select-Object -First 1
        if ($installer) {
          Write-Output "âœ… Found installer: $($installer.Name)"
          # å¯ä»¥æ·»åŠ æ›´å¤šæµ‹è¯•ï¼Œå¦‚é™é»˜å®‰è£…æµ‹è¯•
        } else {
          Write-Error "âŒ No installer found"
          exit 1
        }
      shell: powershell
    
    - name: Upload artifacts
      if: matrix.build
      uses: actions/upload-artifact@v4
      with:
        name: windows-${{ matrix.arch }}-standalone
        path: |
          dist-windows/*.exe
          dist-windows/*.msi
          dist-windows/*.zip
          dist-windows/*.blockmap
          dist-windows/latest*.yml
        retention-days: 30
    
    - name: Restore original package.json
      if: always()
      run: |
        if (Test-Path "package.original.json") {
          Copy-Item package.original.json package.json -Force
          Remove-Item package.original.json -Force
        }
      shell: powershell
  
  release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Prepare release files
      run: |
        mkdir -p release-files
        find artifacts -name "*.exe" -o -name "*.msi" -o -name "*.zip" | while read file; do
          cp "$file" release-files/
        done
        ls -la release-files/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: windows-v${{ github.event.inputs.version }}
        name: Miaoda Windows v${{ github.event.inputs.version }}
        body: |
          # ðŸŽ‰ Miaoda Windows ç‹¬ç«‹ç‰ˆæœ¬ v${{ github.event.inputs.version }}
          
          ## ðŸ“¦ ä¸‹è½½é€‰é¡¹
          
          ### 64ä½ç³»ç»Ÿ (æŽ¨è)
          - **Miaoda-${{ github.event.inputs.version }}-x64.exe** - NSIS å®‰è£…ç¨‹åº
          - **Miaoda-${{ github.event.inputs.version }}-x64.msi** - MSI ä¼ä¸šéƒ¨ç½²åŒ…
          - **Miaoda-${{ github.event.inputs.version }}-x64.zip** - ä¾¿æºç‰ˆ
          
          ### 32ä½ç³»ç»Ÿ
          - **Miaoda-${{ github.event.inputs.version }}-ia32.exe** - NSIS å®‰è£…ç¨‹åº
          - **Miaoda-${{ github.event.inputs.version }}-ia32.zip** - ä¾¿æºç‰ˆ
          
          ## âœ¨ Windows ç‰ˆæœ¬ç‰¹æ€§
          
          - ðŸ–¥ï¸ **åŽŸç”Ÿ Windows ä½“éªŒ** - Fluent Design é£Žæ ¼ UI
          - ðŸ’» **PowerShell ä¼˜å…ˆ** - æ”¯æŒ PowerShell Core å’Œä¼ ç»Ÿ PowerShell
          - ðŸš€ **ConPTY ç»ˆç«¯** - çœŸå®žçš„ Windows ç»ˆç«¯ä½“éªŒ
          - ðŸ”§ **çŽ¯å¢ƒè‡ªåŠ¨æ£€æµ‹** - æ™ºèƒ½æ£€æµ‹ Windows ä¾èµ–
          - ðŸ“¦ **å¤šç§å®‰è£…æ–¹å¼** - NSISã€MSIã€ä¾¿æºç‰ˆå¯é€‰
          
          ## ðŸ› ï¸ ç³»ç»Ÿè¦æ±‚
          
          - Windows 10 ç‰ˆæœ¬ 1803 æˆ–æ›´é«˜
          - Windows 11ï¼ˆæŽ¨èï¼‰
          - .NET Framework 4.7.2+ï¼ˆé€šå¸¸å·²é¢„è£…ï¼‰
          - æœ€å°‘ 4GB RAMï¼ŒæŽ¨è 8GB+
          
          ## ðŸ“ å®‰è£…è¯´æ˜Ž
          
          1. æ ¹æ®æ‚¨çš„ç³»ç»Ÿé€‰æ‹©å¯¹åº”ç‰ˆæœ¬
          2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
          3. å¦‚é‡ Windows Defender è­¦å‘Šï¼Œé€‰æ‹©"æ›´å¤šä¿¡æ¯"â†’"ä»è¦è¿è¡Œ"
          4. æŒ‰ç…§å®‰è£…å‘å¯¼å®Œæˆå®‰è£…
          
          ## ðŸš€ å¿«é€Ÿå¼€å§‹
          
          1. å¯åŠ¨ Miaoda
          2. ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹çŽ¯å¢ƒ
          3. ä½¿ç”¨é…ç½®å‘å¯¼è®¾ç½® AI æœåŠ¡
          4. å¼€å§‹ä½¿ç”¨ï¼
          
          ---
          
          **æ³¨æ„**: è¿™æ˜¯ Windows ç‹¬ç«‹ç‰ˆæœ¬ï¼Œä¸“é—¨é’ˆå¯¹ Windows å¹³å°ä¼˜åŒ–ã€‚
        files: |
          release-files/*
        draft: true
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  notify:
    needs: [build-windows, release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Build Summary
      run: |
        echo "## ðŸ—ï¸ Windows Standalone Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ github.event.inputs.version || 'development' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build 32-bit**: ${{ github.event.inputs.build_32bit != 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build MSI**: ${{ github.event.inputs.build_msi != 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build-windows.result }}" == "success" ]; then
          echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Build failed" >> $GITHUB_STEP_SUMMARY
        fi