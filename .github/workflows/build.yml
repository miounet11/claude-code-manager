name: Build

on:
  workflow_call:
    inputs:
      platform:
        description: 'ç›®æ ‡å¹³å° (all, windows, macos, linux)'
        required: false
        default: 'all'
        type: string
      upload_artifacts:
        description: 'æ˜¯å¦ä¸Šä¼ æž„å»ºäº§ç‰©'
        required: false
        default: true
        type: boolean
    outputs:
      build_status:
        description: 'æž„å»ºçŠ¶æ€'
        value: ${{ jobs.build.result }}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            script: npm run dist-win
            artifacts: "dist/*.exe dist/*.zip"
          - os: macos-latest  
            platform: macos
            script: npm run dist-mac
            artifacts: "dist/*.dmg dist/*-mac.zip"
          - os: ubuntu-latest
            platform: linux
            script: npm run build -- --linux
            artifacts: "dist/*.AppImage dist/*.deb"
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js çŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: æ¸…ç†ç¼“å­˜
      run: npm cache clean --force
      continue-on-error: true
      
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: éªŒè¯ package.json é…ç½®
      run: |
        echo "éªŒè¯æž„å»ºé…ç½®..."
        node -e "
          const pkg = require('./package.json');
          console.log('åº”ç”¨åç§°:', pkg.build.productName);
          console.log('åº”ç”¨ID:', pkg.build.appId);
          console.log('ç‰ˆæœ¬:', pkg.version);
          if (pkg.build.win) console.log('Windows é…ç½®:', JSON.stringify(pkg.build.win, null, 2));
          if (pkg.build.mac) console.log('macOS é…ç½®:', JSON.stringify(pkg.build.mac, null, 2));
          if (pkg.build.linux) console.log('Linux é…ç½®:', JSON.stringify(pkg.build.linux, null, 2));
        "
        
    - name: æ£€æŸ¥èµ„æºæ–‡ä»¶
      run: |
        echo "æ£€æŸ¥å¿…éœ€çš„èµ„æºæ–‡ä»¶..."
        if [ "${{ matrix.platform }}" = "windows" ]; then
          if [ ! -f "assets/icon.ico" ]; then
            echo "è­¦å‘Š: ç¼ºå°‘ Windows å›¾æ ‡æ–‡ä»¶ assets/icon.ico"
            exit 1
          fi
        elif [ "${{ matrix.platform }}" = "macos" ]; then
          if [ ! -f "assets/icon.icns" ]; then
            echo "è­¦å‘Š: ç¼ºå°‘ macOS å›¾æ ‡æ–‡ä»¶ assets/icon.icns"
            exit 1
          fi
        elif [ "${{ matrix.platform }}" = "linux" ]; then
          if [ ! -f "assets/icon.png" ]; then
            echo "è­¦å‘Š: ç¼ºå°‘ Linux å›¾æ ‡æ–‡ä»¶ assets/icon.png"
            exit 1
          fi
        fi
        echo "èµ„æºæ–‡ä»¶æ£€æŸ¥é€šè¿‡"
      shell: bash
      
    - name: æ‰§è¡Œæž„å»º - ${{ matrix.platform }}
      if: inputs.platform == 'all' || inputs.platform == matrix.platform
      run: ${{ matrix.script }}
      env:
        CI: true
        
    - name: éªŒè¯æž„å»ºç»“æžœ
      if: inputs.platform == 'all' || inputs.platform == matrix.platform
      run: |
        echo "éªŒè¯æž„å»ºç»“æžœ..."
        if [ -d "dist" ]; then
          echo "âœ… æž„å»ºæˆåŠŸï¼"
          echo ""
          echo "æž„å»ºäº§ç‰©:"
          ls -la dist/
          echo ""
          echo "æ–‡ä»¶å¤§å°:"
          du -h dist/* 2>/dev/null || echo "æ— æ³•è®¡ç®—æ–‡ä»¶å¤§å°"
        else
          echo "âŒ æž„å»ºå¤±è´¥ï¼šæœªæ‰¾åˆ° dist ç›®å½•"
          exit 1
        fi
      shell: bash
      
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      if: (inputs.platform == 'all' || inputs.platform == matrix.platform) && inputs.upload_artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-build
        path: ${{ matrix.artifacts }}
        retention-days: 30
        if-no-files-found: warn
        
    - name: ç”Ÿæˆæž„å»ºæŠ¥å‘Š
      if: inputs.platform == 'all' || inputs.platform == matrix.platform
      run: |
        echo "## ðŸ”¨ ${{ matrix.platform }} æž„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **å¹³å°**: ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡ŒçŽ¯å¢ƒ**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "dist" ]; then
          echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
      shell: bash
